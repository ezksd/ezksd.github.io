<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Ezksd</title>
  
  <subtitle>ezksd&#39;s blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://ezksd.github.io/"/>
  <updated>2021-06-26T13:14:30.033Z</updated>
  <id>https://ezksd.github.io/</id>
  
  <author>
    <name>ezksd</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Java DIRECT IO</title>
    <link href="https://ezksd.github.io/2021/01/09/java-direct-io/"/>
    <id>https://ezksd.github.io/2021/01/09/java-direct-io/</id>
    <published>2021-01-09T15:09:47.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<p>java 10 æ”¯æŒäº†DIRECT IOï¼Œå¯ä»¥ç»•è¿‡page cacheç›´æ¥å†™æ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Path path = Paths.get(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">FileChannel channel = FileChannel.open(path, StandardOpenOption.WRITE, ExtendedOpenOption.DIRECT);</span><br></pre></td></tr></table></figure><p>DIRECT IOéœ€è¦å¯¹é½ï¼Œä½†æ˜¯ä»–æœ‰ä¸€äº›éå¸¸å¾®å¦™çš„åœ°æ–¹ã€‚</p><h2 id="é‚£äº›åœ°æ–¹éœ€è¦å¯¹é½ï¼š"><a href="#é‚£äº›åœ°æ–¹éœ€è¦å¯¹é½ï¼š" class="headerlink" title="é‚£äº›åœ°æ–¹éœ€è¦å¯¹é½ï¼š"></a>é‚£äº›åœ°æ–¹éœ€è¦å¯¹é½ï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Util.checkChannelPositionAligned(position(), alignment);</span><br><span class="line">Util.checkBufferPositionAligned(bb, pos, alignment);</span><br><span class="line">Util.checkRemainingBufferSizeAligned(rem, alignment);</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«æ˜¯ï¼š</p><ol><li>æ–‡ä»¶å†™å…¥ä½ç½®</li><li>directBufferèµ·å§‹åœ°å€</li><li>directBufferä¸­å‰©ä½™æ•°æ®çš„é•¿åº¦</li></ol><p>ä»–ä»¬éƒ½å¿…é¡»æ˜¯alignmentçš„æ•´æ•°å€ã€‚</p><h2 id="æŒ‰å¤šå°‘å­—èŠ‚å¯¹é½ï¼Ÿ"><a href="#æŒ‰å¤šå°‘å­—èŠ‚å¯¹é½ï¼Ÿ" class="headerlink" title="æŒ‰å¤šå°‘å­—èŠ‚å¯¹é½ï¼Ÿ"></a>æŒ‰å¤šå°‘å­—èŠ‚å¯¹é½ï¼Ÿ</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jint JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_sun_nio_ch_FileDispatcherImpl_setDirect0</span><span class="params">(JNIEnv *env, jclass clazz,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           jobject fdo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jint fd = <span class="built_in">fdval</span>(env, fdo);</span><br><span class="line">    jint result;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MACOSX</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">statvfs</span> <span class="title">file_stat</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">statvfs64</span> <span class="title">file_stat</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MACOSX</span></span><br><span class="line">    result = <span class="built_in">fstatvfs</span>(fd, &amp;file_stat);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    result = <span class="built_in">fstatvfs64</span>(fd, &amp;file_stat);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(result == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">JNU_ThrowIOExceptionWithLastError</span>(env, <span class="string">&quot;DirectIO setup failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = (<span class="keyword">int</span>)file_stat.f_frsize;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    result == <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>statvfs.frsizeæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„é€»è¾‘å—å¤§å°ï¼Œå¯èƒ½åŒ…å«å¤šä¸ªç‰©ç†å—ã€‚</p><blockquote><p>unsigned long  f_frsize;   /* Fragment size */</p></blockquote><h2 id="å¦‚ä½•è·å¾—èµ·å§‹èµ·å§‹ä½ç½®æ˜¯å¯¹é½çš„directBuffer"><a href="#å¦‚ä½•è·å¾—èµ·å§‹èµ·å§‹ä½ç½®æ˜¯å¯¹é½çš„directBuffer" class="headerlink" title="å¦‚ä½•è·å¾—èµ·å§‹èµ·å§‹ä½ç½®æ˜¯å¯¹é½çš„directBuffer"></a>å¦‚ä½•è·å¾—èµ·å§‹èµ·å§‹ä½ç½®æ˜¯å¯¹é½çš„directBuffer</h2><p>ç³»ç»Ÿåˆ†é…çš„å†…å­˜è™šæ‹Ÿåœ°å€å¹¶ä¸ç¡®å®šï¼Œéœ€è¦åˆ†é…å¤§ä¸€äº›çš„ç©ºé—´(pagesize + capcity)ï¼Œåªä½¿ç”¨å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> size = Math.max(<span class="number">1L</span>, (<span class="keyword">long</span>)cap + (pa ? ps : <span class="number">0</span>));</span><br></pre></td></tr></table></figure><p>å‡å¦‚è®¾ç½®äº†<code>-Dsun.nio.PageAlignDirectMemory=true</code>å‚æ•°ä¼šè‡ªåŠ¨å¯¹é½ã€‚</p><blockquote><p>æ³¨ï¼šè¿™åœºjdké‡Œçš„æ³¨é‡Šæ˜¯é”™çš„ï¼Œ-XX:MaxDirectMemorySize=<size>æ²¡æœ‰ä»»ä½•ä½œç”¨</p></blockquote><p>è¿™é‡ŒDirectByteBufferä¼šæŠŠ<strong>æ•´æ®µ</strong>åˆ†é…çš„å†…å­˜å†™0ï¼Œè€Œä¸ä»…ä»…æ˜¯ç”¨åˆ°çš„éƒ¨åˆ†ã€‚å¯¼è‡´æ²¡ç”¨åˆ°çš„è™šæ‹Ÿå†…å­˜ä¹Ÿä¼šåˆ†é…ç‰©ç†å†…å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    base = UNSAFE.allocateMemory(size);</span><br><span class="line">&#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">    Bits.unreserveMemory(size, cap);</span><br><span class="line">    <span class="keyword">throw</span> x;</span><br><span class="line">&#125;</span><br><span class="line">UNSAFE.setMemory(base, size, (<span class="keyword">byte</span>) <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="comment">// Round up to page boundary</span></span><br><span class="line">    address = base + ps - (base &amp; (ps - <span class="number">1</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    address = base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾åˆ†é…ä¸€é¡µå†…å­˜ï¼Œè™šæ‹Ÿåœ°å€æ¨ªè·¨ä¸¤é¡µï¼Œ<strong>æœ€ç»ˆä¼šå¯¼è‡´åˆ†é…ä¸¤å€çš„ç‰©ç†å†…å­˜</strong>ã€‚å¦‚æœåˆ†é…å°é‡å†…å­˜æˆ–è€…å¼€å¯å¤§é¡µæƒ…å†µå¯èƒ½ä¼šæ›´ä¸¥é‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _4K = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">static</span> Object[] save = <span class="keyword">new</span> Object[<span class="number">256</span> * <span class="number">1024</span>];</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span> * <span class="number">1024</span>; i++) &#123;</span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocateDirect(_4K);</span><br><span class="line">            save[i] = buffer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>).await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä»½ä»£ç ä¸å¸¦å¯¹é½å‚æ•°å ç”¨çš„ç‰©ç†å†…å­˜çº¦ä¸º1Gï¼Œè€ŒåŠ ä¸Š<code>-Dsun.nio.PageAlignDirectMemory=true</code>å°†å ç”¨2Gã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -XX:NativeMemoryTracking=summary -XX:MaxDirectMemorySize=1g -Dsun.nio.PageAlignDirectMemory=<span class="literal">true</span> Hello</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> jcmd 29084 VM.native_memory</span></span><br><span class="line">29084:</span><br><span class="line">Native Memory Tracking:</span><br><span class="line">Total: reserved=7840547KB, committed=2470423KB</span><br><span class="line">-                     Other (reserved=2097152KB, committed=2097152KB)</span><br><span class="line">                            (malloc=2097152KB #262144)</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°<code>-XX:MaxDirectMemorySize=1g</code>ï¼Œä½†æ˜¯DirectMemoryè¿œè¿œè¶…å‡ºäº†1gã€‚</p><h2 id="MaxDirectMemorySizeçš„é€»è¾‘"><a href="#MaxDirectMemorySizeçš„é€»è¾‘" class="headerlink" title="MaxDirectMemorySizeçš„é€»è¾‘"></a>MaxDirectMemorySizeçš„é€»è¾‘</h2><p>Bits.tryReserveMemoryæ˜¯æŒ‰åˆ†é…çš„å®¹é‡ç®—çš„ï¼Œè€Œä¸æ˜¯å®é™…åˆ†é…çš„å†…å­˜å¤§å°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">tryReserveMemory</span><span class="params">(<span class="keyword">long</span> size, <span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -XX:MaxDirectMemorySize limits the total capacity rather than the</span></span><br><span class="line">    <span class="comment">// actual memory usage, which will differ when buffers are page</span></span><br><span class="line">    <span class="comment">// aligned.</span></span><br><span class="line">    <span class="keyword">long</span> totalCap;</span><br><span class="line">    <span class="keyword">while</span> (cap &lt;= MAX_MEMORY - (totalCap = TOTAL_CAPACITY.get())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (TOTAL_CAPACITY.compareAndSet(totalCap, totalCap + cap)) &#123;</span><br><span class="line">            RESERVED_MEMORY.addAndGet(size);</span><br><span class="line">            COUNT.incrementAndGet();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨å¼€å¯å¯¹é½çš„æ—¶å€™size = cap + pageSizeï¼Œæ˜¾ç„¶sizeè¦æ¯”capå¤§å¾—å¤šã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;java 10 æ”¯æŒäº†DIRECT IOï¼Œå¯ä»¥ç»•è¿‡page cacheç›´æ¥å†™æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/spa
      
    
    </summary>
    
      <category term="java" scheme="https://ezksd.github.io/categories/java/"/>
    
    
  </entry>
  
  <entry>
    <title>Javaç±»å‹ç³»ç»Ÿ</title>
    <link href="https://ezksd.github.io/2020/12/31/java-type-system/"/>
    <id>https://ezksd.github.io/2020/12/31/java-type-system/</id>
    <published>2020-12-31T00:48:14.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ÎºiÎ¶sãƒ¤ç•¶éä¸»æµæˆç‚ºä¸»æµã‚·<br>javaä¸€ç›´æ˜¯é¢å‘å¯¹è±¡è¯­è¨€çš„ä»£è¡¨ã€‚ç›®å‰å¤§éƒ¨åˆ†è¯­è¨€éƒ½æ”¯æŒé¢å‘å¯¹è±¡ï¼ŒåŒæ—¶é¢å‘å¯¹è±¡çš„æ¦‚å¿µä¹Ÿå˜å¾—æ¨¡ç³Šã€‚</p></blockquote><p>Javaçš„é¢å‘å¯¹è±¡ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p><ol><li>æ•°æ®å’Œå‡½æ•°æ‰“åŒ…ï¼Œåœ¨è¿™é‡Œå‡½æ•°ç§°ä¸ºæ–¹æ³•ï¼Œä»–çš„ç¬¬ä¸€ä¸ªå‚æ•°é»˜è®¤æ˜¯thisã€‚</li><li>åŸºäºç»§æ‰¿å’Œå­ç±»å‹çš„ç±»å‹ç³»ç»Ÿã€‚</li></ol><p>è¿™ä¸¤ç‚¹åˆæœ‰ä¸€ç‚¹äº¤å‰ï¼ŒthisæŒ‡å‘çš„å¯¹è±¡ç±»å‹ä¸åŒï¼Œä¼šåˆ†æ´¾åˆ°ä¸åŒçš„æ–¹æ³•ï¼ˆè™šæ–¹æ³•ï¼‰ã€‚è€Œå¯¹äºç¬¬ä¸€ç‚¹ï¼Œä»–åˆå’Œé—­åŒ…ç±»ä¼¼ï¼ŒJava8ä»¥å‰ç”¨å¯¹è±¡æ¥æ¨¡æ‹Ÿå‡½æ•°ï¼Œäº‹å®ä¸Šå±•ç¤ºäº†ä¸¤è€…çš„å…±æ€§ã€‚è€Œè¿™ç§è®¾è®¡æš—ç¤ºå¯¹è±¡æ˜¯æœ‰çŠ¶æ€çš„ï¼Œè¿™ç§è®¾è®¡å’Œå‡½æ•°å¼ä¸åŒã€‚åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­ï¼Œå¯å˜çŠ¶æ€åº”è¯¥ä»å‚æ•°ä¸­ä¼ å…¥ï¼Œä»è¿”å›å€¼ä¸­å–å‡ºã€‚</p><p>è€Œç¬¬äºŒç‚¹ï¼Œä¸€ç›´è¢«å„ç§é»‘çš„å‡èŒƒå‹ï¼Œä»¥åŠä¸ºäº†å…¼å®¹è£¸ç±»å‹åšå‡ºçš„å¦¥åï¼ˆé€šé…ç¬¦ï¼‰ï¼Œä¹Ÿæ˜¯è¿™ä¸ªè¯­è¨€æœ€ç‹¬ç‰¹ï¼ˆæ¶å¿ƒï¼‰çš„åœ°æ–¹ã€‚</p><h2 id="ä¸€ä¸ªåç›´è§‰çš„ä¾‹å­"><a href="#ä¸€ä¸ªåç›´è§‰çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªåç›´è§‰çš„ä¾‹å­"></a>ä¸€ä¸ªåç›´è§‰çš„ä¾‹å­</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;E&gt; <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(List&lt;E&gt; l1,List&lt;E&gt; l2)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    List&lt;?&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    test(list, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Main.java:12: error: method <span class="built_in">test</span> <span class="keyword">in</span> class Main cannot be applied to given types;</span><br><span class="line">        <span class="built_in">test</span>(list, list);</span><br><span class="line">        ^</span><br><span class="line">  required: List&lt;E&gt;,List&lt;E&gt;</span><br><span class="line">  found:    List&lt;CAP<span class="comment">#1&gt;,List&lt;CAP#2&gt;</span></span><br><span class="line">  reason: inference variable E has incompatible equality constraints CAP<span class="comment">#2,CAP#1</span></span><br><span class="line">  <span class="built_in">where</span> E is a type-variable:</span><br><span class="line">    E extends Object declared <span class="keyword">in</span> method &lt;E&gt;<span class="built_in">test</span>(List&lt;E&gt;,List&lt;E&gt;)</span><br><span class="line">  <span class="built_in">where</span> CAP<span class="comment">#1,CAP#2 are fresh type-variables:</span></span><br><span class="line">    CAP<span class="comment">#1 extends Object from capture of ?</span></span><br><span class="line">    CAP<span class="comment">#2 extends Object from capture of ?</span></span><br><span class="line">1 error</span><br></pre></td></tr></table></figure><p>é”™è¯¯æç¤ºäº†è¿™ä¸¤ä¸ª<code>List&lt;E&gt;</code>ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œåœ¨ä¸åŒçš„åœ°æ–¹ä»£è¡¨ç€ä¸åŒçš„ç±»å‹ã€‚å‡å¦‚æˆ‘ä»¬æƒ³æš—ç¤ºä¸¤ä¸ªå‚æ•°æ˜¯åŒä¸€ä¸ªç±»å‹ï¼Œåƒè¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;E,L extends List&lt;E&gt;&gt; <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(L l1,L l2)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    List&lt;?&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    test(list, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Main.java:12: error: method <span class="built_in">test</span> <span class="keyword">in</span> class Main cannot be applied to given types;</span><br><span class="line">        <span class="built_in">test</span>(list, list);</span><br><span class="line">        ^</span><br><span class="line">  required: L,L</span><br><span class="line">  found:    List&lt;CAP<span class="comment">#1&gt;,List&lt;CAP#2&gt;</span></span><br><span class="line">  reason: inference variable E has incompatible equality constraints CAP<span class="comment">#1,CAP#2</span></span><br><span class="line">  <span class="built_in">where</span> L,E are type-variables:</span><br><span class="line">    L extends List&lt;E&gt; declared <span class="keyword">in</span> method &lt;E,L&gt;<span class="built_in">test</span>(L,L)</span><br><span class="line">    E extends Object declared <span class="keyword">in</span> method &lt;E,L&gt;<span class="built_in">test</span>(L,L)</span><br><span class="line">  <span class="built_in">where</span> CAP<span class="comment">#1,CAP#2 are fresh type-variables:</span></span><br><span class="line">    CAP<span class="comment">#1 extends Object from capture of ?</span></span><br><span class="line">    CAP<span class="comment">#2 extends Object from capture of ?</span></span><br><span class="line">1 error</span><br></pre></td></tr></table></figure><p>ä¾ç„¶ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œé—®é¢˜åœ¨äºListçš„å…ƒç´ ç±»å‹å¯¹ä¸ä¸Šã€‚äºæ˜¯æˆ‘ä»¬åŠ ä¸Š<code>? extends E</code>ï¼Œl1å’Œl2çš„ç±»å‹å‚æ•°ä¾ç„¶ä¸åŒï¼Œä½†è¿™ä¸€æ¬¡Eä»£è¡¨è¿™ä¸¤ä¸ªç±»å‹çš„å…±åŒä¸Šç•Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;E,L extends List&lt;? extends E&gt;&gt; <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(L l1,L l2)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    List&lt;?&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    test(list, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å­˜åœ¨ç±»å‹"><a href="#å­˜åœ¨ç±»å‹" class="headerlink" title="å­˜åœ¨ç±»å‹"></a>å­˜åœ¨ç±»å‹</h2><p>æ­¤å¤„ä¸æ·±å…¥è®¨è®ºç±»å‹è®ºï¼Œè€Œä¸”æˆ‘ä¹Ÿä¸æ‡‚ï¼Œä»…å±•ç¤ºå­˜åœ¨ç±»å‹å’ŒèŒƒå‹ä¹‹é—´çš„åŒºåˆ«ã€‚ä»¥Rustä¸ºä¾‹ï¼Œè¿™ä¸ªè¯­è¨€å°±ä¸æ”¯æŒå­ç±»å‹ï¼ŒåŒæ—¶Rustä¸­çš„é—­åŒ…åˆå¦‚æ­¤ç‰¹åˆ«ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> j = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> f = || i;</span><br><span class="line">    f = || j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">= note: expected closure `[closure@src/main.rs:4:17: 4:21]`</span><br><span class="line">            found closure `[closure@src/main.rs:5:9: 5:13]`</span><br><span class="line">= note: no two closures, even <span class="keyword">if</span> identical, have the same <span class="built_in">type</span></span><br></pre></td></tr></table></figure><blockquote><p>ä¸–ç•Œä¸Šæ²¡æœ‰ä¸¤ç‰‡ç›¸åŒçš„å¶å­ï¼ŒRusté‡Œä¹Ÿæ²¡æœ‰ä¸¤ä¸ªç›¸åŒçš„closuure</p></blockquote><p>è€Œä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ä¸œè¥¿ï¼Œåœ¨ä¸æ”¯æŒå­ç±»å‹çš„åŒæ—¶ï¼Œè¦å¦‚ä½•è¡¨ç¤ºä»–çš„ç±»å‹å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å­˜åœ¨ç±»å‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">closure</span></span>() -&gt; <span class="keyword">impl</span> <span class="built_in">Fn</span>() -&gt; <span class="built_in">i32</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">move</span> || i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼åœ¨å‡½æ•°å†…éƒ¨ç»™å‡ºï¼Œæ­¤æ—¶ç¼–è¯‘å™¨å·²ç»ä¸èƒ½é€šè¿‡ç±»å‹æ¨å¯¼æ¥å¸®æˆ‘ä»¬åšå†³å®šäº†ï¼Œè¿™ä¹Ÿæ˜¯å­˜åœ¨ç±»å‹åœ¨Rustä¸­çš„ç”¨å¤„ã€‚</p><h2 id="å›åˆ°java"><a href="#å›åˆ°java" class="headerlink" title="å›åˆ°java"></a>å›åˆ°java</h2><p>javaçš„èŒƒå‹ä¹Ÿæœ‰ä¸€äº›ç±»ä¼¼ï¼Œä»–æ˜¯ä¸å˜çš„ï¼ˆç›¸å¯¹äºåå˜å’Œé€†å˜ï¼‰ï¼Œæ¯”å¦‚å¸¸è§çš„ä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Fruit</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">implements</span> <span class="title">Fruit</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    LinkedList&lt;Fruit&gt; list = <span class="keyword">new</span> LinkedList&lt;Apple&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java: incompatible types: java.util.LinkedList&lt;com.company.Main.Apple&gt; cannot be converted to java.util.LinkedList&lt;com.company.Main.Fruit&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªåå˜çš„é€»è¾‘ï¼Œè€Œ<code>List&lt;Fruit&gt;</code>çš„åœ¨ç±»å‹å‚æ•°Fruitå¤„æ˜¯ä¸å˜çš„ã€‚javaçš„åå˜ä¸å…¶ä»–è¯­è¨€ï¼ˆc#,scala)åŒºåˆ«åœ¨äºjavaçš„åå˜é€»è¾‘åœ¨ä½¿ç”¨çš„æ—¶å€™ç»™å‡ºï¼Œè€Œå…¶ä»–è¯­è¨€åœ¨å®šä¹‰çš„æ—¶å€™ç»™å‡ºã€‚æˆ–è€…è¯´ä»–å¯èƒ½å’Œåå˜æœ¬èº«å°±ä¸ä¸€æ ·ï¼Œjavaè¯­è¨€è§„èŒƒä¸­å…³äºåå˜å”¯äºŒæåˆ°çš„éƒ¨åˆ†æ˜¯è™šæ–¹æ³•ä¸­çš„è¿”å›å€¼åå˜ï¼Œä»¥åŠåå˜è¿”å›å€¼æ–¹æ³•å’Œæ–¹æ³•è¦†ç›–ä¹‹é—´çš„å…³ç³»ã€‚</p><p>è€Œè¿™ä¸€ç‚¹ä¹ŸåŒæ ·æŒ‡å‡ºäº†è¿”å›å€¼å’Œå‚æ•°ç±»å‹æ¨å¯¼çš„ä¸åŒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;String&gt; <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (List&lt;? extends String&gt;)<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶è¿™ä»½ä»£ç ä¹Ÿæ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œå› ä¸ºè¿”å›å€¼åå˜çš„å‰ææ˜¯<strong>è¿”å›å€¼</strong>çš„<strong>ç±»å‹</strong>å¿…é¡»æ˜¯æ–¹æ³•æ ‡å‡ºçš„<strong>è¿”å›å€¼ç±»å‹</strong>çš„å­ç±»å‹ã€‚</p><h2 id="å¦‚ä½•ç†è§£"><a href="#å¦‚ä½•ç†è§£" class="headerlink" title="å¦‚ä½•ç†è§£"></a>å¦‚ä½•ç†è§£</h2><p>å­˜åœ¨ç±»å‹å¦‚æ­¤éš¾ä»¥ç†è§£å’Œåç›´è§‰ï¼Œåœ¨Rustè¯­è¨€ä¸­ä¹ŸåŒæ ·æ˜¯ä¸€ä¸ªæ§›ã€‚å’Œå…¶ä»–çš„è¯­æ³•é™åˆ¶ä¸€æ ·ï¼Œä»–åŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p><ol><li>å¦‚ä½•ç†è§£è¯­æ³•æœ¬èº«</li><li>åœ¨é™åˆ¶ä¹‹ä¸‹å¦‚ä½•å»å†™ä»£ç </li></ol><p>æˆ‘è®¤ä¸ºç¬¬äºŒéƒ¨åˆ†æ›´åŠ é‡è¦ï¼Œæ¯”å¦‚Rustçš„lifetimeå’Œownershipæœ¬èº«å¹¶ä¸éš¾ç†è§£ï¼Œä½†æ˜¯å½¢æˆä¸€å¥—ä»€ä¹ˆæ ·çš„ä»£ç æ˜¯åˆæ³•çš„ç›´è§‰ç›¸å½“çš„å›°éš¾ã€‚</p><p>ä»è¿™ä¸€ç‚¹ä¸Šæ¥è¯´ï¼Œåœ¨ä»€ä¹ˆæ—¶å€™ç”¨åå˜é€†å˜å¯ä»¥å‚è€ƒscalaçš„è¯´æ³•ï¼š</p><blockquote><p>These positions are classied as covariant for the types of immutable fields and method results, and contravariant for method argument types and upper type parameter bounds. Type arguments to a non-variant type parameter are always in non-variant position. The position flips between contra- and co-variant inside a type argument that corresponds to a contravariant parameter. The type system enforces that covariant (respectively, contravariant) type parameters are only used in covariant (contravariant) positions.</p></blockquote><p>ç®€è¦æ¥è¯´ä»£è¡¨ä¸å¯å˜çš„å­—æ®µå’Œè¿”å›å€¼çš„ç±»å‹å‚æ•°æ˜¯åå˜çš„ï¼Œè€Œä»£è¡¨æ–¹æ³•çš„å‚æ•°å’Œç±»å‹å‚æ•°ä¸Šç•Œçš„ç±»å‹å‚æ•°æ˜¯é€†å˜çš„ï¼Œåœ¨é€†å˜å‚æ•°çš„å†…éƒ¨å/é€†å˜åˆæ˜¯åè¿‡æ¥çš„ã€‚ä»–ä»¬åŒæ—¶å‡ºç°çš„æ—¶å€™å°±ä¼šç‰¹åˆ«é˜´é—´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">sort</span><span class="params">(List&lt;? extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; list)</span> </span>&#123;</span><br><span class="line">    list.sort(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™æ˜¯æ ‡å‡†åº“ä¸­çš„ä»£ç </strong>ï¼ŒListçš„å…ƒç´ ç±»å‹æ˜¯åå˜çš„ï¼ŒComparableçš„ç±»å‹å‚æ•°æ˜¯compareToçš„å‚æ•°çš„ç±»å‹æ˜¯é€†å˜çš„ã€‚</p><p>åå˜ç›¸å¯¹äºé€†å˜æ›´å®¹æ˜“ç†è§£ï¼Œä¸€ä¸ªé›†åˆç±»å‹å­˜å‚¨ç€ä¸åŒçš„å…ƒç´ ï¼Œè¿™äº›å…ƒç´ æœ‰å…¬å…±çˆ¶ç±»å‹ã€‚ä½†åå˜çš„å‰ææ˜¯é›†åˆä¸å¯å˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆjavaçš„åå˜æ•°ç»„æ˜¯æœ‰é—®é¢˜çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Fruit</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">implements</span> <span class="title">Fruit</span></span>&#123;&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Orange</span> <span class="keyword">implements</span> <span class="title">Fruit</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Fruit[] fruit = <span class="keyword">new</span> Apple[<span class="number">1</span>];</span><br><span class="line">    fruit[<span class="number">0</span>] = <span class="keyword">new</span> Orange();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.ArrayStoreException: com.company.Main<span class="variable">$Orange</span></span><br><span class="line">    at com.company.Main.main(Main.java:17)</span><br></pre></td></tr></table></figure><p>è€Œç†è§£é€†å˜çš„å…³é”®åœ¨äºåº”è¯¥æŠŠå‡½æ•°ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè€Œä¸æ˜¯å•ç‹¬å»çœ‹ç±»å‹å‚æ•°ä¸ºä»€ä¹ˆåº”è¯¥æ˜¯ä¸‹ç•Œï¼ˆsuper)ã€‚å¯å˜æ€§æœ¬èº«æè¿°çš„å°±æ˜¯å‡å¦‚Aæ˜¯Bçš„å­ç±»å‹ï¼Œä¸¤ä¸ªå€¼ä¹‹é—´çš„å­ç±»å‹å…³ç³»ã€‚è€Œå¯¹äºå‡½æ•°æ¥è¯´ï¼Œä¸€ä¸ªå‡½æ•°ç±»å‹Aå¯¹äºå¦ä¸€ä¸ªå‡½æ•°ç±»å‹Bé€‚ç”¨é¢æ›´å¹¿ï¼Œé‚£ä¹ˆAç±»å‹çš„å€¼å¯ä»¥å‡ºç°åœ¨è¦æ±‚å‡ºç°Bç±»å‹çš„åœ°æ–¹ã€‚</p><p>ä»¥æ°´æœä¸ºä¾‹ï¼Œå‡è®¾æ°´æœä¹‹é—´å¯ä»¥æ¯”è¾ƒé‡é‡ã€‚å¦‚æœä¸æ ‡å‡ºä¸‹ç•Œï¼Œçˆ¶ç±»å·²ç»å®ç°äº†Comparableæ¥å£ï¼Œä½†æ˜¯ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼Œè¿™æ— å½¢ä¸­é™åˆ¶äº†ä»£ç çš„è¡¨è¾¾èƒ½åŠ›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Fruit</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Fruit</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Fruit o)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">implements</span> <span class="title">Fruit</span></span>&#123;&#125;</span><br><span class="line"><span class="keyword">static</span> &lt;T extends Comparable&lt;T&gt;&gt; <span class="function"><span class="keyword">void</span> <span class="title">sort1</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &lt;T extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; <span class="function"><span class="keyword">void</span> <span class="title">sort2</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">    ArrayList&lt;Apple&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    sort1(list);  <span class="comment">//ç¼–è¯‘é”™è¯¯</span></span><br><span class="line">    sort2(list);  <span class="comment">//åˆæ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="javaé‡Œè¿˜æœ‰ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œä¸è¿‡é€‚ç”¨èŒƒå›´æ¯”è¾ƒå±€é™"><a href="#javaé‡Œè¿˜æœ‰ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œä¸è¿‡é€‚ç”¨èŒƒå›´æ¯”è¾ƒå±€é™" class="headerlink" title="javaé‡Œè¿˜æœ‰ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œä¸è¿‡é€‚ç”¨èŒƒå›´æ¯”è¾ƒå±€é™"></a>javaé‡Œè¿˜æœ‰ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œä¸è¿‡é€‚ç”¨èŒƒå›´æ¯”è¾ƒå±€é™</h2><h3 id="äº¤ç±»å‹"><a href="#äº¤ç±»å‹" class="headerlink" title="äº¤ç±»å‹"></a>äº¤ç±»å‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ha</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">he</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;T extends A &amp; B&gt; <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">    t.ha();</span><br><span class="line">    t.he();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºJavaæœ¬èº«ä¸æ”¯æŒå¤šç»§æ‰¿ï¼Œäº¤ç±»å‹é‡Œåªèƒ½æœ‰ä¸€ä¸ªclassè€Œä¸”åªèƒ½æ”¾åœ¨ç¬¬ä¸€ä½ã€‚</p><h3 id="å¹¶ç±»å‹"><a href="#å¹¶ç±»å‹" class="headerlink" title="å¹¶ç±»å‹"></a>å¹¶ç±»å‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Exception</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">Exception</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(flag)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> A();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> B();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (A | B a) &#123;</span><br><span class="line">        a.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªèƒ½åœ¨å¼‚å¸¸å—ä¸­ä½¿ç”¨ï¼Œè¡¨ç¤ºå¯èƒ½å‡ºç°çš„å¼‚å¸¸ç±»å‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;ÎºiÎ¶sãƒ¤ç•¶éä¸»æµæˆç‚ºä¸»æµã‚·&lt;br&gt;javaä¸€ç›´æ˜¯é¢å‘å¯¹è±¡è¯­è¨€çš„ä»£è¡¨ã€‚ç›®å‰å¤§éƒ¨åˆ†è¯­è¨€éƒ½æ”¯æŒé¢å‘å¯¹è±¡ï¼ŒåŒæ—¶é¢å‘å¯¹è±¡çš„æ¦‚å¿µä¹Ÿå˜å¾—æ¨¡ç³Šã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Javaçš„é¢å‘å¯¹è±¡ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ•°æ®å’Œå‡½æ•°æ‰“åŒ…
      
    
    </summary>
    
      <category term="java" scheme="https://ezksd.github.io/categories/java/"/>
    
      <category term="rust" scheme="https://ezksd.github.io/categories/rust/"/>
    
    
  </entry>
  
  <entry>
    <title>NIOå’Œepollçš„å…³ç³»</title>
    <link href="https://ezksd.github.io/2020/08/27/nio/"/>
    <id>https://ezksd.github.io/2020/08/27/nio/</id>
    <published>2020-08-27T18:15:14.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<p>nioåœ¨linuxå¯¹åº”çš„å®ç°æ˜¯epollã€‚åœ¨linuxä¸­ï¼Œæ‰€æœ‰I/Oéƒ½æŠ½è±¡ä¸ºæ–‡ä»¶ï¼ˆåŒ…æ‹¬ç½‘ç»œå’Œæ–‡ä»¶è¯»å†™)ï¼Œç”¨æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰æ¥æ ‡è¯†ã€‚fdæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œ å…¶ä¸­0ï¼Œ1ï¼Œ2åˆ†åˆ«å¯¹åº”<code>stdin</code>ï¼Œ<code>stdout</code>ï¼Œ<code>stderr</code>ã€‚<br>epollåŒ…å«ä¸‰ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol><li>epoll_createï¼šåˆ›å»ºä¸€ä¸ªepoll instanceå¹¶è¿”å›ä¸€ä¸ªfdä»£è¡¨ä»–ï¼Œå¯¹åº”<code>Selector</code>ã€‚</li><li>epoll_ctlï¼šæ³¨å†ŒI/Oäº‹ä»¶ï¼Œå¯¹åº”<code>SelectableChannel.register()</code>ã€‚</li><li>epoll_waitï¼šç­‰å¾…I/Oäº‹ä»¶ï¼Œå¯¹åº”<code>Selector.select()</code>ã€‚</li></ol><h2 id="OP-ACCEPT-å’Œ-OP-CONNECT"><a href="#OP-ACCEPT-å’Œ-OP-CONNECT" class="headerlink" title="OP_ACCEPT å’Œ OP_CONNECT"></a>OP_ACCEPT å’Œ OP_CONNECT</h2><blockquote><pre><code>  EPOLLIN         The associated file is available for read(2) operations.  EPOLLOUT         The associated file is available for write(2) operations.  EPOLLRDHUP (since Linux 2.6.17)         Stream socket peer closed connection, or shut down writing         half of connection.  (This flag is especially useful for writâ€         ing simple code to detect peer shutdown when using edge-trigâ€         gered monitoring.)  EPOLLPRI         There is an exceptional condition on the file descriptor.  See         the discussion of POLLPRI in poll(2).  EPOLLERR         Error condition happened on the associated file descriptor.         This event is also reported for the write end of a pipe when         the read end has been closed.         epoll_wait(2) will always report for this event; it is not         necessary to set it in events when calling epoll_ctl().  EPOLLHUP         Hang up happened on the associated file descriptor.         epoll_wait(2) will always wait for this event; it is not necâ€         essary to set it in events when calling epoll_ctl().         Note that when reading from a channel such as a pipe or a         stream socket, this event merely indicates that the peer         closed its end of the channel.  Subsequent reads from the         channel will return 0 (end of file) only after all outstanding         data in the channel has been consumed.  EPOLLET         Requests edge-triggered notification for the associated file         descriptor.  The default behavior for epoll is level-trigâ€         gered.  See epoll(7) for more detailed information about edge-         triggered and level-triggered notification.         This flag is an input flag for the event.events field when         calling epoll_ctl(); it is never returned by epoll_wait(2).  EPOLLONESHOT (since Linux 2.6.2)         Requests one-shot notification for the associated file deâ€         scriptor.  This means that after an event notified for the         file descriptor by epoll_wait(2), the file descriptor is disâ€         abled in the interest list and no other events will be reâ€         ported by the epoll interface.  The user must call epoll_ctl()         with EPOLL_CTL_MOD to rearm the file descriptor with a new         event mask.         This flag is an input flag for the event.events field when         calling epoll_ctl(); it is never returned by epoll_wait(2).</code></pre></blockquote><p>å¯ä»¥æ³¨æ„åˆ°ï¼Œå’ŒSelectionKeyä¸­çš„äº‹ä»¶æœ‰ä¸€äº›å·®åˆ«ï¼Œæ¯”å¦‚è¿™é‡Œæ²¡æœ‰OP_ACCEPTå’ŒOP_CONNECTã€‚é‚£ä¹ˆè¿™ä¸¤ä¸ªäº‹ä»¶æ˜¯åšä»€ä¹ˆçš„ğŸ¤”ï¼Ÿ</p><h2 id="ACCEPT"><a href="#ACCEPT" class="headerlink" title="ACCEPT"></a>ACCEPT</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">translateInterestOps</span><span class="params">(<span class="keyword">int</span> ops)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newOps = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((ops &amp; SelectionKey.OP_ACCEPT) != <span class="number">0</span>)</span><br><span class="line">        newOps |= Net.POLLIN;</span><br><span class="line">    <span class="keyword">return</span> newOps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>OP_ACCEPTå˜æˆäº†Net.POLLINã€‚è€Œå¯¹äº<code>CONNECT</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">translateInterestOps</span><span class="params">(<span class="keyword">int</span> ops)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newOps = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((ops &amp; SelectionKey.OP_READ) != <span class="number">0</span>)</span><br><span class="line">        newOps |= Net.POLLIN;</span><br><span class="line">    <span class="keyword">if</span> ((ops &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>)</span><br><span class="line">        newOps |= Net.POLLOUT;</span><br><span class="line">    <span class="keyword">if</span> ((ops &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>)</span><br><span class="line">        newOps |= Net.POLLCONN;</span><br><span class="line">    <span class="keyword">return</span> newOps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>POLLCONNå’ŒPOLLOUTä¸€æ ·å‡ä¸º4ï¼Œé€šè¿‡socketçš„çŠ¶æ€è¿›è¡ŒåŒºåˆ†ã€‚å¦‚æœsocketæœªè¿æ¥ä»£è¡¨OP_CONNECT,å·²è¿æ¥ä»£è¡¨OP_WRITEã€‚å¦‚æœè¯´æŠŠPOLLINæ‹†åˆ†æˆACCEPTå’ŒREADå°šå¯ç†è§£ï¼Œé‚£æŠŠOUTæ‹†æˆWRITEå’ŒCONNECTæ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><h2 id="OP-CONNECTæ˜¯åœ¨åšä»€ä¹ˆ"><a href="#OP-CONNECTæ˜¯åœ¨åšä»€ä¹ˆ" class="headerlink" title="OP_CONNECTæ˜¯åœ¨åšä»€ä¹ˆ"></a>OP_CONNECTæ˜¯åœ¨åšä»€ä¹ˆ</h2><p>è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å®¹æ˜“è¯¯è§£çš„åœ°æ–¹ï¼Œå®¢æˆ·ç«¯è°ƒç”¨connect,æœåŠ¡ç«¯è°ƒè§¦å‘OP_ACCEPTäº‹ä»¶ï¼Œè°ƒç”¨acceptä¹‹åå®¢æˆ·ç«¯è§¦å‘OP_CONNECTäº‹ä»¶ï¼Œè°ƒç”¨finishConnectã€‚çœ‹ä¸Šå»å’Œä¸‰æ¬¡æ¡æ‰‹å®Œå…¨ä¸€è‡´ï¼Œä½†å®Œå…¨ä¸æ˜¯é‚£å›äº‹ï¼Œé€šè¿‡wiresharkè°ƒè¯•å¾—çŸ¥åœ¨æœåŠ¡ç«¯è°ƒç”¨acceptæ—¶ä¸‰æ¬¡æ¡æ‰‹å·²ç»å®Œæˆäº†ã€‚é‚£ä¹ˆOP_CONNECTå’ŒfinishConnectåˆ†åˆ«æ˜¯åœ¨åšä»€ä¹ˆï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> polled = Net.pollConnectNow(fd);</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">jint fd = fdval(env, fdo);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">poller</span>;</span></span><br><span class="line"><span class="keyword">int</span> result;</span><br><span class="line"></span><br><span class="line">poller.fd = fd;</span><br><span class="line">poller.events = POLLOUT;</span><br><span class="line">poller.revents = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (timeout &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">    timeout = <span class="number">-1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout &gt; INT_MAX) &#123;</span><br><span class="line">    timeout = INT_MAX;</span><br><span class="line">&#125;</span><br><span class="line">result = poll(&amp;poller, <span class="number">1</span>, (<span class="keyword">int</span>)timeout);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°jniæ–¹æ³•åªæ˜¯åœ¨ç”¨poll()æ£€æŸ¥è¯¥fdçš„POLLOUTäº‹ä»¶ã€‚è€ŒPOLLOUTè¡¨ç¤ºsocketç¼“å†²åŒºå¯å†™ï¼Œéšå«è¿æ¥å·²ç»å»ºç«‹ã€‚æ‰€ä»¥å¯¹äºé˜»å¡çš„finishConnect()ï¼Œä»–ä¼šé˜»å¡åˆ°è¿æ¥å»ºç«‹ï¼Œè€Œéé˜»å¡çš„finishConnectï¼Œç”¨è¿”å›å€¼ä»£è¡¨è¿æ¥æ˜¯å¦å»ºç«‹ã€‚è¿™ä¸ªæ–¹æ³•åå¾ˆæœ‰è¯¯å¯¼æ€§ï¼Œ<del>å»ºè®®æ”¹ä¸ºdoesItFinishConnect</del>ï¼Œæˆ–è€…è¯´éé˜»å¡çš„connectå¥½åƒç”¨å¤„ä¸å¤§ã€‚</p><h2 id="é”™è¯¯"><a href="#é”™è¯¯" class="headerlink" title="é”™è¯¯"></a>é”™è¯¯</h2><p>epolläº‹ä»¶è½¬æ¢ä¸ºNIOäº‹ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">translateReadyOps</span><span class="params">(<span class="keyword">int</span> ops, <span class="keyword">int</span> initialOps,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 SelectionKeyImpl sk)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> intOps = sk.nioInterestOps(); <span class="comment">// Do this just once, it synchronizes</span></span><br><span class="line">    <span class="keyword">int</span> oldOps = sk.nioReadyOps();</span><br><span class="line">    <span class="keyword">int</span> newOps = initialOps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ops &amp; Net.POLLNVAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This should only happen if this channel is pre-closed while a</span></span><br><span class="line">        <span class="comment">// selection operation is in progress</span></span><br><span class="line">        <span class="comment">// ## Throw an error if this channel has not been pre-closed</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ops &amp; (Net.POLLERR | Net.POLLHUP)) != <span class="number">0</span>) &#123;</span><br><span class="line">        newOps = intOps;</span><br><span class="line">        sk.nioReadyOps(newOps);</span><br><span class="line">        <span class="comment">// No need to poll again in checkConnect,</span></span><br><span class="line">        <span class="comment">// the error will be detected there</span></span><br><span class="line">        readyToConnect = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> (newOps &amp; ~oldOps) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((ops &amp; Net.POLLIN) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        ((intOps &amp; SelectionKey.OP_READ) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        (state == ST_CONNECTED))</span><br><span class="line">        newOps |= SelectionKey.OP_READ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((ops &amp; Net.POLLCONN) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        ((intOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        ((state == ST_UNCONNECTED) || (state == ST_PENDING))) &#123;</span><br><span class="line">        newOps |= SelectionKey.OP_CONNECT;</span><br><span class="line">        readyToConnect = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((ops &amp; Net.POLLOUT) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        ((intOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        (state == ST_CONNECTED))</span><br><span class="line">        newOps |= SelectionKey.OP_WRITE;</span><br><span class="line"></span><br><span class="line">    sk.nioReadyOps(newOps);</span><br><span class="line">    <span class="keyword">return</span> (newOps &amp; ~oldOps) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼š</p><ol><li><p>POLLNVALæ²¡æœ‰è®¾ç½®ä»»ä½•ReadyOpsï¼ŒPOLLNAVALçš„å€¼ä¸º32ï¼Œåœ¨ä¸Šè¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„é¡¹ã€‚å¦‚æ³¨é‡Šæ‰€è¯´ï¼Œåº”è¯¥æ˜¯APIä½¿ç”¨é”™è¯¯ä¸å»ç®¡ä»–ã€‚</p></li><li><p>POLLERRå’ŒROLLHUPåŸå°ä¸åŠ¨å¤åˆ¶äº†intOpsï¼Œä¹Ÿå°±æ˜¯ä¼š<strong>è§¦å‘æ‰€æœ‰æ³¨å†Œçš„äº‹ä»¶</strong>ã€‚</p></li></ol><p>è¿™é‡Œè¿˜ç¿»åˆ°Nettyçš„ä¸€ä¸ªissue<a href="https://github.com/netty/netty/issues/924">https://github.com/netty/netty/issues/924</a>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span></span><br><span class="line">    <span class="comment">// See https://github.com/netty/netty/issues/924</span></span><br><span class="line">    <span class="keyword">int</span> ops = k.interestOps();</span><br><span class="line">    ops &amp;= ~SelectionKey.OP_CONNECT;</span><br><span class="line">    k.interestOps(ops);</span><br><span class="line"></span><br><span class="line">    unsafe.finishConnect();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.</span></span><br><span class="line"><span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write</span></span><br><span class="line">    ch.unsafe().forceFlush();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></span><br><span class="line"><span class="comment">// to a spin loop</span></span><br><span class="line"><span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123;</span><br><span class="line">    unsafe.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nettyçš„OP_CONNECTå¤„ç†åœ¨ç¬¬ä¸€ä½ï¼Œå½“å¯¹æ–¹å‘é€Resetæ—¶ï¼Œé¦–å…ˆä¼šè¿›å…¥unsafe.finishConnect()ï¼Œè€Œè¿™é‡Œå¹¶æ²¡æœ‰å–æ¶ˆäº‹ä»¶ä¹Ÿæ²¡æœ‰å…³é—­è¿æ¥çš„é€»è¾‘ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ³¨æ„åˆ°ä¸Šé¢ä»£ç çš„æœ€åä¸€è¡Œï¼ŒJavaæŠŠINäº‹ä»¶åˆ†ç¦»æˆACCEPTå’ŒREADï¼Œä½†æ˜¯NettyåˆæŠŠACCEPTå’ŒREADç»Ÿä¸€èµ·æ¥ï¼ŒServerSocketçš„è¯»å¤„ç†å°±æ˜¯è°ƒç”¨Accept:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    SocketChannel ch = SocketUtils.accept(javaChannel());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="keyword">null</span>) &#123;</span><br><span class="line">            buf.add(<span class="keyword">new</span> NioSocketChannel(<span class="keyword">this</span>, ch));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Failed to create a new channel from an accepted socket.&quot;</span>, t);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ch.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Failed to close a socket.&quot;</span>, t2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªäº‹æƒ…çš„æ„Ÿè§‰å°±æ˜¯éƒ½æœ‰è‡ªå·±è¿™ä¹ˆåšçš„ç†ç”±ï¼Œä½†æ˜¯ç»„åˆèµ·æ¥å°±ååˆ†æ»‘ç¨½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;nioåœ¨linuxå¯¹åº”çš„å®ç°æ˜¯epollã€‚åœ¨linuxä¸­ï¼Œæ‰€æœ‰I/Oéƒ½æŠ½è±¡ä¸ºæ–‡ä»¶ï¼ˆåŒ…æ‹¬ç½‘ç»œå’Œæ–‡ä»¶è¯»å†™)ï¼Œç”¨æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰æ¥æ ‡è¯†ã€‚fdæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œ å…¶ä¸­0ï¼Œ1ï¼Œ2åˆ†åˆ«å¯¹åº”&lt;code&gt;stdin&lt;/code&gt;ï¼Œ&lt;code&gt;stdout&lt;/code&gt;ï¼Œ&lt;code&gt;stde
      
    
    </summary>
    
      <category term="java" scheme="https://ezksd.github.io/categories/java/"/>
    
    
  </entry>
  
  <entry>
    <title>Javaæ ‡å‡†åº“ä¸­ä¸€å¤„ä¸å¤ªåˆç†çš„åœ°æ–¹</title>
    <link href="https://ezksd.github.io/2020/08/05/generic-heap/"/>
    <id>https://ezksd.github.io/2020/08/05/generic-heap/</id>
    <published>2020-08-05T20:44:34.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ³›å‹"><a href="#æ³›å‹" class="headerlink" title="æ³›å‹"></a>æ³›å‹</h2><p><del>ä¼—æ‰€å‘¨çŸ¥</del>ï¼ŒJavaçš„æ³›å‹éå¸¸æ‹‰ç¨€ã€‚è™½ç„¶æˆ‘è®¤ä¸ºåœ¨è¡¨è¾¾èƒ½åŠ›å·®ä¸å¤šçš„æƒ…å†µä¸‹ï¼Œåˆ«çš„éƒ½å¯ä»¥å¿å¿ã€‚Javaçš„è¡¨è¾¾èƒ½åŠ›å·®åœ¨å“ªé‡Œå‘¢ï¼š</p><ol><li><p>ä¸èƒ½åˆ›å»ºæ³›å‹æ•°ç»„<br> å¯ä»¥ç”¨Object[]åŠ å¼ºåˆ¶è½¬å‹ï¼Œä¸æ­¤åŒæ—¶æ–¹æ³•è¿˜è¦åŠ ä¸Š@SuppressWarnings(â€œuncheckedâ€)ï¼Œä¸ç„¶ä¼šæœ‰ç¼–è¯‘æœŸè­¦å‘Šã€‚</p></li><li><p>ä¸èƒ½é€šè¿‡æ³›å‹åˆ›å»ºå¯¹è±¡<br> å¯ä»¥æŠŠClass&lt;T&gt;ä½œä¸ºå‚æ•°ï¼Œåœ¨å†…éƒ¨ç”¨åå°„è°ƒæ„é€ å‡½æ•°ã€‚è¿™ç§æƒ…å†µéå¸¸æ™®éï¼Œä½†åœ¨Java8æˆ–ä»¥ä¸Šç‰ˆæœ¬ä¸­å¹¶ä¸åˆé€‚ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå‚æ•°Class&lt;T&gt;æ”¹ä¸ºSupplier&lt;T&gt;ï¼Œè®²ç©¶ä¸€ç‚¹å¯ä»¥å†™æˆSupplier&lt;? extends T&gt;ï¼Œç„¶åè°ƒç”¨çš„æ—¶å€™ä¼ å…¥æ„é€ å™¨æ–¹æ³•å¼•ç”¨ã€‚ï¼ˆç›®å‰è¿˜æƒ³ä¸å‡ºç‰¹åˆ«å¥½çš„ä¾‹å­å±•ç¤ºè¿™ä¸¤è€…çš„åŒºåˆ«ï¼Œæƒ³åˆ°å†è¡¥ï¼‰</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;E&gt; <span class="function">E <span class="title">construct</span><span class="params">(Supplier&lt;? extends E&gt; sup)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sup.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String s = construct(String::<span class="keyword">new</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä¸¾ä¸€ä¸ªnettyçš„ä¾‹å­ï¼š</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">b.group(group)</span><br><span class="line"> .channel(NioSocketChannel.class) <span class="comment">// çœ‹è¿™é‡Œ</span></span><br><span class="line"> .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line"> .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">         ChannelPipeline p = ch.pipeline();</span><br><span class="line">         <span class="keyword">if</span> (sslCtx != <span class="keyword">null</span>) &#123;</span><br><span class="line">             p.addLast(sslCtx.newHandler(ch.alloc(), HOST, PORT));</span><br><span class="line">         &#125;</span><br><span class="line">         p.addLast(<span class="keyword">new</span> EchoClientHandler());</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p> è€Œchannelå‡½æ•°æ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼š</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> B <span class="title">channel</span><span class="params">(Class&lt;? extends C&gt; channelClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> channelFactory(<span class="keyword">new</span> ReflectiveChannelFactory&lt;C&gt;(</span><br><span class="line">            ObjectUtil.checkNotNull(channelClass, <span class="string">&quot;channelClass&quot;</span>)</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> è¿™é‡ŒChannelFactoryç­‰ä»·äºSupplier&lt;T extends Channel&gt;ï¼Œ<br> åªéœ€è¦ç”¨channelFactory(NioSocketChannel::new)å°±å¯ä»¥äº†ã€‚::newè¿˜æ¯”.classå°‘ä¸€ä¸ªå­—ç¬¦ï¼Œåœ¨java9ä»¥ä¸Šç‰ˆæœ¬åå°„å¯èƒ½ä¼šå‡ºç°å¾®å¦™çš„é—®é¢˜ï¼Œè€Œåå°„å”¯ä¸€çš„ä¼˜ç‚¹æ˜¯èƒ½è°ƒç”¨ç§æœ‰çš„æ„é€ å‡½æ•°ã€‚</p></li><li><p>ä¸æ”¯æŒåå˜é€†å˜ï¼Œæˆ–è€…è¯´ä»¥ä¸€ä¸ªéš¾çœ‹çš„æ–¹å¼æ”¯æŒéƒ¨åˆ†åå˜é€†å˜</p></li><li><p><del>æš‚æ—¶æ²¡æœ‰ç¬¬å››</del></p></li></ol><h2 id="å¯å˜æ€§-åå˜-é€†å˜"><a href="#å¯å˜æ€§-åå˜-é€†å˜" class="headerlink" title="å¯å˜æ€§(åå˜/é€†å˜)"></a>å¯å˜æ€§(åå˜/é€†å˜)</h2><p>Javaçš„å¯å˜æ€§å’Œå…¶ä»–è¯­è¨€(æ¯”å¦‚Scala, C#)é‡Œæœ€å¤§çš„åŒºåˆ«åœ¨äºJavaçš„å¯å˜æ€§åœ¨ä½¿ç”¨çš„æ—¶å€™æ ‡æ˜(æ¯”å¦‚å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œä»£å…¥ç±»å‹å‚æ•°)ï¼Œè€Œå…¶ä»–è¯­è¨€åœ¨å®šä¹‰ç±»/æ¥å£/ç‰¹è´¨çš„æ—¶å€™æ ‡æ˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collection&lt;? extends A&gt; collections = ...;</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collection</span>[+<span class="type">A</span>]</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>æ ‡å‡†åº“é‡Œçš„PriorityQueue&lt;E&gt;ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å †ï¼Œå®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">final</span> <span class="title">Comparator</span>&lt;? <span class="title">super</span> <span class="title">E</span>&gt; <span class="title">comparator</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(initialCapacity, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span><span class="params">(Comparator&lt;? <span class="keyword">super</span> E&gt; comparator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_INITIAL_CAPACITY, comparator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="params"><span class="function">                         Comparator&lt;? <span class="keyword">super</span> E&gt; comparator)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Note: This restriction of at least one is not actually needed,</span></span><br><span class="line">        <span class="comment">// but continues for 1.5 compatibility</span></span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">        <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çœ‹è¿™é‡Œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">siftUpComparable</span><span class="params">(<span class="keyword">int</span> k, T x, Object[] es)</span> </span>&#123;</span><br><span class="line">        Comparable&lt;? <span class="keyword">super</span> T&gt; key = (Comparable&lt;? <span class="keyword">super</span> T&gt;) x; </span><br><span class="line">        <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> parent = (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">            Object e = es[parent];</span><br><span class="line">            <span class="keyword">if</span> (key.compareTo((T) e) &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            es[k] = e;</span><br><span class="line">            k = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        es[k] = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®šComparatorï¼Œå¦‚æœTæœ¬èº«æ˜¯Comparableçš„å­ç±»å‹çš„è¯ä¹Ÿå¯ä»¥ä¸ç”¨æŒ‡å®šï¼Œæ­¤æ—¶comparatorä¸ºç©ºï¼Œæ¯”è¾ƒçš„æ—¶å€™ä¼šå¼ºåˆ¶è½¬å‹ä¸ºComparableã€‚ä½†æ˜¯å¦‚æœè¿™ä¸ªæ—¶å€™æˆ‘ä¸å°å¿ƒåˆ›å»ºäº†ä¸€ä¸ªæ²¡æœ‰å®ç°Comparableçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œç¼–è¯‘æœŸä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼Œè¿è¡Œçš„æ—¶å€™å°±ç‚¸äº†ã€‚<del>ä¹Ÿå¤ªä¸å°å¿ƒäº†</del><br>ä½†æ˜¯å…¶å®æ˜¯å¯ä»¥åœ¨ç¼–è¯‘æœŸé¿å…è¿™ç§æƒ…å†µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Heap</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    Comparator&lt;? <span class="keyword">super</span> E&gt; comp;</span><br><span class="line">    E[] array;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Heap</span><span class="params">(Comparator&lt;? <span class="keyword">super</span> E&gt; comp, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.comp = comp;</span><br><span class="line">        <span class="keyword">this</span>.array = (E[]) <span class="keyword">new</span> Object[size];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &lt;E extends Comparable&lt;? <span class="keyword">super</span> E&gt;&gt; <span class="function">Heap&lt;E&gt; <span class="title">newHeap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newHeap(Comparable::compareTo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &lt;E&gt; <span class="function">Heap&lt;E&gt; <span class="title">newHeap</span><span class="params">(Comparator&lt;? <span class="keyword">super</span> E&gt; comp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newHeap(comp,<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &lt;E&gt; <span class="function">Heap&lt;E&gt; <span class="title">newHeap</span><span class="params">(Comparator&lt;? <span class="keyword">super</span> E&gt; comp, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Heap&lt;&gt;(comp,size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™é‡Œæ˜¯é™æ€æ–¹æ³•ï¼Œå› ä¸ºç”¨æ„é€ å™¨çš„è¯è¡Œä¸é€šã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;æ³›å‹&quot;&gt;&lt;a href=&quot;#æ³›å‹&quot; class=&quot;headerlink&quot; title=&quot;æ³›å‹&quot;&gt;&lt;/a&gt;æ³›å‹&lt;/h2&gt;&lt;p&gt;&lt;del&gt;ä¼—æ‰€å‘¨çŸ¥&lt;/del&gt;ï¼ŒJavaçš„æ³›å‹éå¸¸æ‹‰ç¨€ã€‚è™½ç„¶æˆ‘è®¤ä¸ºåœ¨è¡¨è¾¾èƒ½åŠ›å·®ä¸å¤šçš„æƒ…å†µä¸‹ï¼Œåˆ«çš„éƒ½å¯ä»¥å¿å¿ã€‚Javaçš„è¡¨è¾¾èƒ½åŠ›å·®åœ¨å“ªé‡Œå‘¢ï¼š&lt;
      
    
    </summary>
    
      <category term="java" scheme="https://ezksd.github.io/categories/java/"/>
    
    
  </entry>
  
  <entry>
    <title>Java 14 ç‰¹æ€§ç®€ä»‹</title>
    <link href="https://ezksd.github.io/2020/06/23/java-14/"/>
    <id>https://ezksd.github.io/2020/06/23/java-14/</id>
    <published>2020-06-23T10:00:00.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<p>java 14å‡ºæ¥å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œç›¸æ¯”ä¹‹å‰çš„å°å¹…æ›´æ–°ï¼Œè¿™ä¸€æ¬¡çš„æ–°å¢è¯­æ³•ç‰¹æ€§è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚è€Œä¸”å‰é¢çš„ä¼—å¤šç‰¹æ€§ï¼ŒåŒ…æ‹¬14ä¸­çš„éƒ¨åˆ†ç‰¹æ€§éƒ½æ˜¯ä¸ºæ¨¡å¼åŒ¹é…åšå‡†å¤‡ï¼ŒåŸºæœ¬ä¸Šå°±å·®ä¸´é—¨ä¸€è„šäº†ã€‚æœ¬æ–‡å°†ä»…å¯¹æ–°å¢è¯­æ³•ç‰¹æ€§åšä¸€ä¸ªç®€å•ä»‹ç»ã€‚</p><h2 id="305-Pattern-Matching-for-instanceof-Preview"><a href="#305-Pattern-Matching-for-instanceof-Preview" class="headerlink" title="305: Pattern Matching for instanceof (Preview)"></a>305: Pattern Matching for instanceof (Preview)</h2><p>è¿™æ˜¯ä¸€ä¸ªpreviewç‰¹æ€§ï¼Œéœ€è¦ç¼–è¯‘çš„æ—¶å€™åŠ ä¸Š<code>--enable-preview</code>å‚æ•°ï¼ŒåŒæ—¶è¿˜è¦æŒ‡å®š<code>--release</code>æˆ–è€…<code>--source</code>ï¼Œä»…ä½œå°é²œä½¿ç”¨ã€‚</p><p>è¿™ä¸ªç‰¹æ€§æœ¬èº«çš„ä½œç”¨æ˜¯ç®€åŒ–<code>instance of</code>çš„ä½¿ç”¨ï¼Œå› ä¸ºå¦‚æœ<code>instance of</code>ä¸ºçœŸï¼Œé‚£ä¹ˆä¹‹åçš„å¼ºåˆ¶è½¬å‹å°±æ˜¾å¾—å¾ˆå¤šä½™ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    String s = (String) obj;</span><br><span class="line">    <span class="comment">// use s</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥å†™æˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String s) &#123;</span><br><span class="line">    <span class="comment">// can use s here</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// can&#x27;t use s here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°ï¼Œæ–°çš„è¯­æ³•<code>instance of</code>ç±»å‹ä¹‹åå¤šäº†ä¸€ä¸ªå˜é‡ï¼Œè¿™ä¹Ÿæ˜¯å”¯ä¸€çš„åŒºåˆ«ã€‚è™½ç„¶ä»–çœ‹ä¸Šå»ä»ç„¶å»æœ‰ç‚¹å¤šä½™ï¼Œä¸ºä»€ä¹ˆä¸åœ¨å¯¹åº”çš„ä½œç”¨åŸŸå†…objçš„ç±»å‹ç›´æ¥å°±å½“æˆStringå‘¢ã€‚æˆ‘çŒœæµ‹æ˜¯è¿™ä¸ªç‰¹æ€§ä¸ºäº†å’Œåç»­çš„æ¨¡å¼åŒ¹é…çš„è§£æ„é£æ ¼ä¿æŒä¸€è‡´ï¼Œæ¯•ç«Ÿè¿™ä¸ªç‰¹æ€§æœ¬èº«å°±æ˜¯ä¸ºæ¨¡å¼åŒ¹é…é“ºè·¯çš„ã€‚</p><h2 id="359-Records-Preview"><a href="#359-Records-Preview" class="headerlink" title="359:    Records (Preview)"></a>359:    Records (Preview)</h2><p>è¿™ä¾ç„¶æ˜¯ä¸€ä¸ªpreviewç‰¹æ€§ï¼Œå®ƒå¾ˆåƒcçš„ç»“æ„ä½“ï¼Œä½†å‡†ç¡®æ¥è®²å®ƒæ›´åƒscalaçš„case classã€‚åŠ ä¸ŠJEP 360: Sealed Classes (Preview)ä¹‹åï¼Œå°±ç­‰äºæ”¯æŒä»£æ•°æ•°æ®ç±»å‹äº†ï¼Œå½“ç„¶ç›®å‰ä¹Ÿå·®ä¸å¤šå¯ä»¥ç”¨äº†ï¼Œå·®åˆ«æ˜¯æ¨¡å¼åŒ¹é…çš„æ—¶å€™ç¼–è¯‘å™¨èƒ½å¦åˆ¤æ–­ä»£ç æœ‰æ²¡æœ‰æŠŠæ‰€æœ‰çš„å¯èƒ½æ€§å†™å…¨ã€‚æŠ›å¼€è¿™äº›ï¼ŒRecordå¯ä»¥è§†ä¸ºä¸€ä¸ªè¯­æ³•ç³–ï¼Œå› ä¸ºä»–ç¼–è¯‘ä¹‹åå¯ä»¥è¿˜åŸæˆä¸€ä¸ªç­‰ä»·çš„classã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°‘å†™å¾ˆå¤šä»£ç ï¼Œå› ä¸ºrecordå¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼šæ„é€ å™¨ï¼Œgetæ–¹æ³•ï¼Œ<code>toString</code>ï¼Œ<code>hashCode</code>ï¼Œ<code>equals</code>æ–¹æ³•ï¼Œ<strong>æ³¨æ„</strong>ï¼šè¿™é‡Œå¹¶æ²¡æœ‰setæ–¹æ³•ï¼Œå› ä¸ºrecordé»˜è®¤æ˜¯ä¸å¯å˜çš„ã€‚è€Œä¸”recordå¯ä»¥å®ç°æ¥å£ï¼Œä½†æ˜¯ä¸èƒ½ç»§æ‰¿å…¶ä»–ç±»ï¼ŒåŒæ—¶é™¤æ­¤ä»¥å¤–å’Œä¸€ä¸ªæ™®é€šçš„classæ²¡æœ‰ä»€ä¹ˆå·®åˆ«ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">record</span> <span class="title">Point</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure><p>è¯­æ³•å¦‚ä¸Šï¼Œå› ä¸ºrecordè¿˜èƒ½æ·»åŠ è‡ªå®šä¹‰æ„é€ å™¨å’Œå®ç°æ–¹æ³•ï¼Œä¸ºäº†ä¿æŒä¸€è‡´è¿˜æ˜¯ä¿ç•™äº†å¤§æ‹¬å·ï¼ˆè™½ç„¶çœ‹ä¸Šå»å¾ˆå¤šä½™ï¼‰ï¼</p><h2 id="JEP-361-Switch-Expressions-Standard"><a href="#JEP-361-Switch-Expressions-Standard" class="headerlink" title="JEP 361: Switch Expressions (Standard)"></a>JEP 361: Switch Expressions (Standard)</h2><p>è¿™ä¸ªä¹‹å‰å°±æœ‰ï¼Œä¸è¿‡åœ¨java 14ä¸­ä¸å†æ˜¯previewç‰¹æ€§äº†ï¼Œç®€å•å°†ï¼Œswitchè¯­å¥æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒæ˜¯æœ‰å€¼çš„ï¼å½“ç„¶è¯­æ³•å’Œswitch statementæœ‰ä¸€äº›å·®åˆ«ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (day) &#123;</span><br><span class="line">    <span class="keyword">case</span> MONDAY, FRIDAY, SUNDAY -&gt; System.out.println(<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">case</span> TUESDAY                -&gt; System.out.println(<span class="number">7</span>);</span><br><span class="line">    <span class="keyword">case</span> THURSDAY, SATURDAY     -&gt; System.out.println(<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">case</span> WEDNESDAY              -&gt; System.out.println(<span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¹¶æ²¡æœ‰ä½“ç°å‡ºswitch expressionsæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¸switch statementçš„æœ€å¤§å·®åˆ«æ˜¯ä»–æ²¡æœ‰fall throughç‰¹æ€§ï¼Œä¸éœ€è¦åˆ°å¤„åŠ breakäº†ï¼</p><p>ç‹å æ›¾ç»è®²ï¼šè®¿é—®è€…æ¨¡å¼åªæ˜¯æ¨¡å¼åŒ¹é…ä¸‘é™‹çš„æ¨¡ä»¿(å¤§æ„)ï¼è§‚ç‚¹æ­£ç¡®ä¸å¦æš‚ä¸”ä¸è®ºï¼Œæ¨¡å¼åŒ¹é…å’Œè§‚å¯Ÿè€…æ¨¡å¼çš„ç¡®æœ‰å¾ˆå¤šå…±åŒä¹‹å¤„ï¼æ¯”å¦‚ä¸€ä¸ªè®¿é—®è€…æ¥å£çš„å®šä¹‰(ä»¥éå†äºŒå‰æ ‘ä¸ºä¾‹)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Node n)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Leaf l)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œ<code>haskell</code>çš„æ¨¡å¼åŒ¹é…å®šä¹‰å¦‚å‡ºä¸€è¾™</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">visit</span> :: <span class="type">Tree</span> e -&gt;ã€€()</span><br><span class="line"><span class="title">visit</span> (<span class="type">Node</span> n) = ...</span><br><span class="line"><span class="title">visit</span> (<span class="type">Leaf</span> f) = ...</span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™äº›è¯­æ³•ç¦»å®Œæ•´çš„æ¨¡å¼åŒ¹é…è¿˜å·®ä¸€è„šï¼Œä¸è¿‡å·²ç»å·®ä¸å¤šå¤Ÿäº†ï¼Œæ¥ä¸‹æ¥å°±ç”¨æ–°çš„è¯­æ³•å†™ä¸€ä¸ªç®€å•çš„è®¡ç®—å™¨ï¼</p><h2 id="è®¡ç®—å™¨"><a href="#è®¡ç®—å™¨" class="headerlink" title="è®¡ç®—å™¨"></a>è®¡ç®—å™¨</h2><p>é¦–å…ˆæ˜¯tokençš„å®šä¹‰ã€‚scalaä¸­æœ‰ä¸case classå¯¹åº”çš„cass objectï¼Œä¹Ÿå°±æ˜¯å•ä¾‹çš„recordã€‚ä¸è¿‡javaç›®å‰è¿˜æ²¡æœ‰ï¼Œç”¨enumä»£æ›¿ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Token</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">record</span> <span class="title">Number</span><span class="params">(<span class="keyword">int</span> i)</span> implements Token</span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Operator</span> <span class="keyword">implements</span> <span class="title">Token</span></span>&#123;</span><br><span class="line">    ADD,MINUS,MULTIPLY,DIVIDED</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Bracket</span> <span class="keyword">implements</span> <span class="title">Token</span></span>&#123;</span><br><span class="line">    LEFT,RIGHT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºjavaæ ‡å‡†åº“ä¸­æ²¡æœ‰tupleï¼Œå†åŠ ä¸€ä¸ªtupleï¼Œç”¨æ¥å½“å¤šè¿”å›å€¼ï¼ŒåŒæ—¶è¿”å›tokenå’Œæ‰€åœ¨çš„ä½ç½®ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">record Tuple&lt;A,B&gt;(A a,B b)&#123;&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯parseréƒ¨åˆ†ï¼Œçœå»äº†tokenizer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Optional&lt;List&lt;Token&gt;&gt; parseAll(String s) &#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> list = <span class="keyword">new</span> LinkedList&lt;Token&gt;();</span><br><span class="line">    <span class="keyword">while</span> (i &lt; s.length()) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = parse(s, i);</span><br><span class="line">        <span class="keyword">if</span> (r.isPresent()) &#123;</span><br><span class="line">            list.add(r.get().a());</span><br><span class="line">            i = r.get().b();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Optional.of(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Optional&lt;Tuple&lt;Token, Integer&gt;&gt; parse(String s, <span class="keyword">int</span> p) &#123;</span><br><span class="line">    <span class="keyword">var</span> c = s.charAt(p);</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;(&#x27;</span> -&gt; Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(Bracket.LEFT, p + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;)&#x27;</span> -&gt; Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(Bracket.RIGHT, p + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span> -&gt; Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(Operator.MULTIPLY, p + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span> -&gt; Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(Operator.DIVIDED, p + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span> -&gt; Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(Operator.ADD, p + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span> -&gt; Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(Operator.MINUS, p + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">default</span> -&gt; parseNumber(s, p);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Optional&lt;Tuple&lt;Token, Integer&gt;&gt; parseNumber(String s, <span class="keyword">int</span> p) &#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!Character.isDigit(s.charAt(p)))&#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.empty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (p &lt; s.length() &amp;&amp; Character.isDigit(s.charAt(p))) &#123;</span><br><span class="line">        i = i * <span class="number">10</span> + (s.charAt(p++) - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(<span class="keyword">new</span> Number(i), p));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯è§£é‡Šéƒ¨åˆ†ï¼Œå·¦é€’å½’æ¶ˆé™¤å°±ä¸èµ˜è¿°äº†ï¼Œç®€å•è¯´ä¸‹æ–‡æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">expr = term expr1</span><br><span class="line">expr1 = (+/-) term expr1 | Îµ</span><br><span class="line">term = digit | term1</span><br><span class="line">term1 = (*//) digit term1 | Îµ</span><br><span class="line">digit = æ•´æ•° | <span class="string">&#x27;(&#x27;</span> expr <span class="string">&#x27;)&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Optional&lt;Tuple&lt;Double,Integer&gt;&gt; expr(List&lt;Token&gt; list,<span class="keyword">int</span> p)&#123;</span><br><span class="line">      <span class="keyword">var</span> term = term(list, p);</span><br><span class="line">      <span class="keyword">return</span> term.flatMap(x -&gt;&#123;</span><br><span class="line">          <span class="keyword">var</span> tuples = expr1(list, x.b());</span><br><span class="line">          <span class="keyword">return</span> tuples.map(xs -&gt; &#123;</span><br><span class="line">              <span class="keyword">double</span> s = x.a();</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">var</span> tuple : xs.a()) &#123;</span><br><span class="line">                  <span class="keyword">switch</span> (tuple.a()) &#123;</span><br><span class="line">                      <span class="keyword">case</span> ADD -&gt; s += tuple.b();</span><br><span class="line">                      <span class="keyword">case</span> MINUS -&gt; s -= tuple.b();</span><br><span class="line">                      <span class="keyword">default</span> -&gt; <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> Tuple&lt;&gt;(s, xs.b());</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Optional&lt;Tuple&lt;List&lt;Tuple&lt;Operator, Double&gt;&gt;, Integer&gt;&gt; expr1(List&lt;Token&gt; list, <span class="keyword">int</span> p)&#123;</span><br><span class="line">      <span class="keyword">var</span> result = <span class="keyword">new</span> LinkedList&lt;Tuple&lt;Operator,Double&gt;&gt;();</span><br><span class="line">      <span class="keyword">while</span> (p &lt; list.size()) &#123;</span><br><span class="line">          <span class="keyword">var</span> token = list.get(p);</span><br><span class="line">          <span class="keyword">var</span> term = term(list, p + <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span>(term.isPresent() &amp;&amp; (token == Operator.ADD || token == Operator.MINUS))&#123;</span><br><span class="line">              result.add(<span class="keyword">new</span> Tuple&lt;&gt;((Operator)token, term.get().a()));</span><br><span class="line">              p = p + <span class="number">2</span>;</span><br><span class="line">          &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(result, p));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Optional&lt;Tuple&lt;Double,Integer&gt;&gt; term(List&lt;Token&gt; list,<span class="keyword">int</span> p)&#123;</span><br><span class="line">      <span class="keyword">var</span> digit = digit(list, p);</span><br><span class="line">      <span class="keyword">return</span> digit.flatMap(x -&gt; &#123;</span><br><span class="line">          <span class="keyword">var</span> tuples = term1(list, x.b());</span><br><span class="line">          <span class="keyword">return</span> tuples.map(xs -&gt; &#123;</span><br><span class="line">              <span class="keyword">double</span> s = x.a();</span><br><span class="line">              <span class="keyword">for</span> (Tuple&lt;Operator, Double&gt; tuple : xs.a()) &#123;</span><br><span class="line">                  <span class="keyword">switch</span> (tuple.a()) &#123;</span><br><span class="line">                      <span class="keyword">case</span> MULTIPLY -&gt; s *= tuple.b();</span><br><span class="line">                      <span class="keyword">case</span> DIVIDED -&gt; s /= tuple.b();</span><br><span class="line">                      <span class="keyword">default</span> -&gt; <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> Tuple&lt;&gt;(s,xs.b());</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Optional&lt;Tuple&lt;List&lt;Tuple&lt;Operator,Double&gt;&gt;,Integer&gt;&gt; term1(List&lt;Token&gt; list,<span class="keyword">int</span> p)&#123;</span><br><span class="line">      <span class="keyword">var</span> result = <span class="keyword">new</span> LinkedList&lt;Tuple&lt;Operator,Double&gt;&gt;();</span><br><span class="line">      <span class="keyword">while</span> (p &lt; list.size()) &#123;</span><br><span class="line">          <span class="keyword">var</span> token = list.get(p);</span><br><span class="line">          <span class="keyword">var</span> term = digit(list, p + <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span>(term.isPresent() &amp;&amp; (token == Operator.MULTIPLY || token == Operator.DIVIDED))&#123;</span><br><span class="line">              result.add(<span class="keyword">new</span> Tuple&lt;&gt;((Operator)token, term.get().a()));</span><br><span class="line">              p = p + <span class="number">2</span>;</span><br><span class="line">          &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(result, p));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Optional&lt;Tuple&lt;Double, Integer&gt;&gt; digit(List&lt;Token&gt; list, <span class="keyword">int</span> p) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p &lt; list.size())&#123;</span><br><span class="line">          <span class="keyword">var</span> t = list.get(p);</span><br><span class="line">          <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Number)</span><br><span class="line">              <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(((<span class="keyword">double</span>) ((Number) list.get(p)).i()), p + <span class="number">1</span>));</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span>(t == Bracket.LEFT)&#123;</span><br><span class="line">              <span class="keyword">return</span> expr(list, p + <span class="number">1</span>).flatMap(x -&gt; &#123;</span><br><span class="line">                  <span class="keyword">if</span> (x.b() &lt; list.size() &amp;&amp; list.get(x.b()) == Bracket.RIGHT) &#123;</span><br><span class="line">                      <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> Tuple&lt;&gt;(x.a(), x.b() + <span class="number">1</span>));</span><br><span class="line">                  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">return</span> Optional.empty();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Optional.empty();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åè¿”å›çš„æ˜¯å€¼å’Œå­—ç¬¦æ‰€åœ¨ä½ç½®çš„tupleï¼Œå†åŠ ä¸€ä¸ªåŒ…è£…å‡½æ•°å°±å®Œå·¥äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Optional&lt;Double&gt; <span class="title">caculate</span><span class="params">(List&lt;Token&gt; tokens)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> list = <span class="keyword">new</span> ArrayList&lt;Token&gt;(tokens.size());</span><br><span class="line">    list.addAll(tokens);</span><br><span class="line">    <span class="keyword">return</span> expr(list,<span class="number">0</span>).map(Tuple::a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç åœ¨<a href="https://gist.github.com/ezksd/fc3da994c668abbabebb6a08e2fa1e9a">è¿™é‡Œ</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;java 14å‡ºæ¥å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œç›¸æ¯”ä¹‹å‰çš„å°å¹…æ›´æ–°ï¼Œè¿™ä¸€æ¬¡çš„æ–°å¢è¯­æ³•ç‰¹æ€§è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚è€Œä¸”å‰é¢çš„ä¼—å¤šç‰¹æ€§ï¼ŒåŒ…æ‹¬14ä¸­çš„éƒ¨åˆ†ç‰¹æ€§éƒ½æ˜¯ä¸ºæ¨¡å¼åŒ¹é…åšå‡†å¤‡ï¼ŒåŸºæœ¬ä¸Šå°±å·®ä¸´é—¨ä¸€è„šäº†ã€‚æœ¬æ–‡å°†ä»…å¯¹æ–°å¢è¯­æ³•ç‰¹æ€§åšä¸€ä¸ªç®€å•ä»‹ç»ã€‚&lt;/p&gt;
&lt;h2 id=&quot;305-Pattern-Matchi
      
    
    </summary>
    
      <category term="java" scheme="https://ezksd.github.io/categories/java/"/>
    
    
  </entry>
  
  <entry>
    <title>Rustçš„ç¼ºç‚¹</title>
    <link href="https://ezksd.github.io/2019/06/02/rust/"/>
    <id>https://ezksd.github.io/2019/06/02/rust/</id>
    <published>2019-06-02T19:17:15.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸–ç•Œæœ‰å¤ªå¤šçš„ä¼ æ•™å£«äº†ï¼Œæ¯”å¦‚<strong>ä¸€éƒ¨åˆ†</strong>Haskellä¼ æ•™å£«ä¼šæ‹¿ä¸€ä¸ªä¸¤è¡Œçš„å¿«æ’ï¼Œä½†æ˜¯ä¸å‘Šè¯‰ä½ é‚£ä¸æ˜¯åŸåœ°æ’åºï¼Œè€Œç­‰ä»·çš„åŸåœ°æ’åºå¯èƒ½æ¯”javaè¿˜é•¿ã€‚</p><p>é‚£RustçœŸçš„æœ‰ä¼ æ•™å£«è¯´çš„é‚£ä¹ˆç¾å—ï¼Œæ˜¯å¦é—æ¼äº†ä»€ä¹ˆã€‚</p><h2 id="traitä¸æ˜¯ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿä¸æ”¯æŒå­ç±»å‹"><a href="#traitä¸æ˜¯ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿä¸æ”¯æŒå­ç±»å‹" class="headerlink" title="traitä¸æ˜¯ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿä¸æ”¯æŒå­ç±»å‹"></a>traitä¸æ˜¯ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿä¸æ”¯æŒå­ç±»å‹</h2><p>å½“ç„¶ï¼Œè¿™å¯èƒ½æ˜¯è®¾è®¡éœ€è¦ï¼Œä½†è®©äººéš¾å—ä½†åœ°æ–¹ï¼Œæˆ‘å…ˆæŠŠä»–å½’ç±»ä¸ºç¼ºç‚¹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">compare</span></span>(a: <span class="built_in">Ord</span>,b: <span class="built_in">Ord</span>) -&gt; <span class="built_in">bool</span>&#123;</span><br><span class="line">    a &lt; b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">error[E0038]: the trait `std::cmp::Ord` cannot be made into an object</span><br><span class="line"> --&gt; src/main.rs:2:15</span><br><span class="line">  |</span><br><span class="line">2 | fn compare(a: Ord,b: Ord) -&gt; bool&#123;</span><br><span class="line">  |               ^^^ the trait `std::cmp::Ord` cannot be made into an object</span><br><span class="line">  |</span><br><span class="line">  = note: the trait cannot use `Self` as a <span class="built_in">type</span> parameter <span class="keyword">in</span> the supertraits or where-clauses</span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä½ å¯ä»¥ç”¨ç±»å‹æ¨å¯¼ï¼Œè¿™é‡Œè¦æ±‚è¯¥ç±»å‹å®ç°äº†<code>Ord</code> traitï¼Œ äºæ˜¯æˆ‘ä»¬å°±å¯ä»¥ç”¨<code>&lt;</code>æ¥æ¯”è¾ƒäº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">compare</span></span>&lt;A:<span class="built_in">Ord</span>&gt;(a: A,b: A) -&gt; <span class="built_in">bool</span>&#123;</span><br><span class="line">    a &lt; b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸å­ç±»å‹æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œæ¯”å¦‚åœ¨è¿”å›å€¼ä½ç½®å°±æ²¡åŠæ³•è¿™ä¹ˆå†™äº†ã€‚è¿”å›å€¼åœ¨å‡½æ•°å†…éƒ¨å·²ç»ç»™å‡ºï¼Œæ¨å¯¼çš„æ—¶å€™å°±å¯¹ä¸ä¸Šäº†ã€‚</p><blockquote><p>å†æ„›ä½ ï¼Œä¾ç„¶æ˜¯å…©å€‹äººï½</p></blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">compare</span></span>&lt;A:<span class="built_in">Ord</span>&gt;() -&gt; A&#123;</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">error[E0308]: mismatched types</span><br><span class="line"> --&gt; src/main.rs:3:5</span><br><span class="line">  |</span><br><span class="line">2 | fn compare&lt;A:Ord&gt;() -&gt; A&#123;</span><br><span class="line">  |                        - expected `A` because of <span class="built_in">return</span> <span class="built_in">type</span></span><br><span class="line">3 |     1</span><br><span class="line">  |     ^ expected <span class="built_in">type</span> parameter, found <span class="built_in">integer</span></span><br><span class="line">  |</span><br><span class="line">  = note: expected <span class="built_in">type</span> `A`</span><br><span class="line">             found <span class="built_in">type</span> `&#123;<span class="built_in">integer</span>&#125;`</span><br></pre></td></tr></table></figure><p>ä¸æ˜¯æ‰€æœ‰çš„å€¼éƒ½æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç±»å‹ï¼Œæ¯”å¦‚é—­åŒ…ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦å­˜åœ¨ç±»å‹ï¼š</p><blockquote><p>ä¸–ç•Œä¸Šæ²¡æœ‰ä¸¤ç‰‡ç›¸åŒçš„å¶å­ï¼ŒRusté‡Œä¹Ÿæ²¡æœ‰ä¸¤ä¸ªçš„é—­åŒ…</p></blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">counter</span></span>() -&gt; <span class="keyword">impl</span> <span class="built_in">Fn</span>() -&gt; <span class="built_in">i32</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> i = <span class="number">0</span>;</span><br><span class="line">    || &#123;</span><br><span class="line">        <span class="keyword">let</span> r = i;</span><br><span class="line">        i = i + <span class="number">1</span>;</span><br><span class="line">        r</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸æ­¤åŒæ—¶å­˜åœ¨ç±»å‹æ˜¯ä¸€ä¸ªéå¸¸éš¾ç”¨çš„ä¸œè¥¿ï¼Œä»–å¯¹åº”å­˜åœ¨é‡è¯<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="1.258ex" height="1.57ex" role="img" focusable="false" viewBox="0 -694 556 694" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-N-2203" d="M56 661T56 674T70 694H487Q497 686 500 679V15Q497 10 487 1L279 0H70Q56 7 56 20T70 40H460V327H84Q70 334 70 347T84 367H460V654H70Q56 661 56 674Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="2203" xlink:href="#MJX-1-TEX-N-2203"></use></g></g></g></svg></mjx-container>ï¼Œè€ŒèŒƒå‹å¯¹åº”å…¨ç§°é‡è¯<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex" xmlns="http://www.w3.org/2000/svg" width="1.258ex" height="1.62ex" role="img" focusable="false" viewBox="0 -694 556 716" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-N-2200" d="M0 673Q0 684 7 689T20 694Q32 694 38 680T82 567L126 451H430L473 566Q483 593 494 622T512 668T519 685Q524 694 538 694Q556 692 556 674Q556 670 426 329T293 -15Q288 -22 278 -22T263 -15Q260 -11 131 328T0 673ZM414 410Q414 411 278 411T142 410L278 55L414 410Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="2200" xlink:href="#MJX-1-TEX-N-2200"></use></g></g></g></svg></mjx-container>ã€‚</p><h2 id="å»¶æ—¶æ±‚å€¼"><a href="#å»¶æ—¶æ±‚å€¼" class="headerlink" title="å»¶æ—¶æ±‚å€¼"></a>å»¶æ—¶æ±‚å€¼</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Iterator</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¬ä¸Šå»å¾ˆç¾ï¼Œä½†å‡è®¾ä»–ä¸åšæ‰€è°“çš„å»¶æ—¶æ±‚å€¼ï¼Œç”šè‡³éƒ½æ²¡æœ‰åŠæ³•æŠ½è±¡å‡ºæ¥ä¸€å¥—ä¸œè¥¿ã€‚</p><p>æ¯”å¦‚mapæ–¹æ³•å¹¶æ²¡æœ‰ç«‹åˆ»è½¬æ¢ï¼Œè€Œæ˜¯ç›´æ¥æŠŠåŸæ¥çš„Iteratorå’Œå‡½æ•°åŒ…åœ¨äº†ç»“æ„ä½“é‡Œï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">map</span></span>&lt;B, F&gt;(<span class="keyword">self</span>, f: F) -&gt; Map&lt;<span class="keyword">Self</span>, F&gt; <span class="keyword">where</span></span><br><span class="line"><span class="keyword">Self</span>: <span class="built_in">Sized</span>, F: <span class="built_in">FnMut</span>(Self::Item) -&gt; B,</span><br><span class="line">&#123;</span><br><span class="line">  Map::new(<span class="keyword">self</span>, f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡å¦‚ä½ æƒ³æŠŠä»–çš„è¿”å›å€¼æ”¹æˆ<code>Iterator&lt;Item=B&gt;</code>æ˜¯ç¼–è¯‘ä¸è¿‡çš„ï¼Œå› ä¸ºtraitä¸æ˜¯ç±»å‹ã€‚è¿™é‡Œéœ€è¦ä¸€ä¸ªå…·ä½“çš„ç±»å‹ï¼Œæ¯”å¦‚ç»“æ„ä½“æˆ–è€…æšä¸¾ï¼Œäºæ˜¯ä½ ä¼šçœ‹åˆ°å¤§é‡è¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">step_by</span></span>(<span class="keyword">self</span>, step: <span class="built_in">usize</span>) -&gt; StepBy&lt;<span class="keyword">Self</span>&gt;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">chain</span></span>&lt;U&gt;(<span class="keyword">self</span>, other: U) -&gt; Chain&lt;<span class="keyword">Self</span>, U::IntoIter&gt;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">zip</span></span>&lt;U&gt;(<span class="keyword">self</span>, other: U) -&gt; Zip&lt;<span class="keyword">Self</span>, U::IntoIter&gt;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">map</span></span>&lt;B, F&gt;(<span class="keyword">self</span>, f: F) -&gt; Map&lt;<span class="keyword">Self</span>, F&gt;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">filter</span></span>&lt;P&gt;(<span class="keyword">self</span>, predicate: P) -&gt; Filter&lt;<span class="keyword">Self</span>, P&gt;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">enumerate</span></span>(<span class="keyword">self</span>) -&gt; Enumerate&lt;<span class="keyword">Self</span>&gt; </span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">peekable</span></span>(<span class="keyword">self</span>) -&gt; Peekable&lt;<span class="keyword">Self</span>&gt;</span><br></pre></td></tr></table></figure><p>æ¯å®šä¹‰ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œä½ å°±éœ€è¦å®šä¹‰ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼ˆå› ä¸ºä½ ä¸èƒ½åœ¨åŒä¸€ä¸ªç»“æ„ä½“ä¸Šå®ç°åŒä¸€ä¸ªtraitä¸¤æ¬¡ï¼‰ï¼Œç„¶åå†åœ¨ç»“æ„ä½“ä¸Šå®ç°traitçš„æ–¹æ³•ã€‚è¿™ç§ä»£ç é£æ ¼Javaç¨‹åºå‘˜ä¸€å®šå¾ˆç†Ÿæ‚‰ï¼Œæˆ‘æŠŠä»–ç§°ä¸ºå®åå†…éƒ¨ç±»ã€‚å¦‚æœæ¯”Iteratorå®˜æ–¹å®ç°çš„ä»£ç é•¿åº¦ï¼ŒRustè‚¯å®šæ˜¯é¦–å±ˆä¸€æŒ‡çš„ã€‚</p><p>å¦‚æœåªæ˜¯ä»£ç é•¿å€’ä¸æ˜¯å¾ˆå¤§çš„é—®é¢˜ï¼Œæ¯•ç«Ÿæˆ‘æ˜¯ä¸€åJavaç¨‹åºå‘˜ã€‚</p><p>å†çœ‹ä¸€ä¸ªå…·ä½“ä¸€ç‚¹çš„é—®é¢˜ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">flat_map</span></span>&lt;U, F&gt;(<span class="keyword">self</span>, f: F) -&gt; FlatMap&lt;<span class="keyword">Self</span>, U, F&gt;</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">Self</span>: <span class="built_in">Sized</span>, U: <span class="built_in">IntoIterator</span>, F: <span class="built_in">FnMut</span>(Self::Item) -&gt; U,</span><br><span class="line">&#123;</span><br><span class="line">    FlatMap::new(<span class="keyword">self</span>, f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>F</code>ï¼ˆè¿™é‡Œä»£è¡¨ä¸€ä¸ªå‡½æ•°ï¼‰çš„è¿”å›å€¼ç±»å‹<code>U</code>æ˜¯æ ¹æ®ç±»å‹æ¨å¯¼æ¥çš„ï¼Œè¿™å°±é€ æˆä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚å‡½æ•°ä¸­æœ‰if elseæˆ–è€…æ¨¡å¼åŒ¹é…è¿™æ ·çš„åˆ†æ”¯ï¼Œä¸¤ä¸ªåˆ†æ”¯çš„ç±»å‹ä¼šå¯¹ä¸ä¸Šã€‚æ³¨æ„è¿™é‡Œå¦‚æœä¸ç”¨returnï¼Œifè¡¨è¾¾å¼çš„ç±»å‹å°±å·²ç»å¯¹ä¸ä¸Šäº†ï¼ˆåœ¨Rustä¸­if elseæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå’ŒScalaç±»ä¼¼ï¼‰ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> j = (<span class="number">1</span>..<span class="number">9</span>).flat_map(|x|&#123;</span><br><span class="line">    <span class="keyword">if</span> (x % <span class="number">2</span>) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> empty();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">vec!</span>[x].iter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).collect();</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">error[E0308]: mismatched types</span><br><span class="line"> --&gt; src/main.rs:8:16</span><br><span class="line">  |</span><br><span class="line">8 |         return vec![x].iter();</span><br><span class="line">  |                ^^^^^^^^^^^^^^ expected struct `std::iter::Empty`, found struct `std::slice::Iter`</span><br><span class="line">  |</span><br><span class="line">  = note: expected type `std::iter::Empty&lt;_&gt;`</span><br><span class="line">             found type `std::slice::Iter&lt;&#x27;_, &#123;integer&#125;&gt;`</span><br></pre></td></tr></table></figure><p>å‡å¦‚ä½ çš„ä»£ç é‡Œå‡ºç°äº†åˆ†æ”¯ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨çš„map,å¦å¤–ä¸€ä¸ªç”¨çš„filter,é‚£ä»–ç±»å‹æ˜¯å¯¹ä¸ä¸Šçš„ï¼Œç”šè‡³äºè¯´éƒ½æ˜¯map,é—­åŒ…çš„ç±»å‹ä¹Ÿå¯¹ä¸ä¸Šï¼ˆé—­åŒ…æ˜¯Mapçš„ç±»å‹å‚æ•°ï¼‰ã€‚</p><blockquote><p>å¦‚æœä½ å¬è¯´Rustæ”¯æŒtype classï¼Œæƒ³æ¥æç‚¹å‡½æ•°å¼ï¼Œä½ æ˜¯å¦æé”™äº†ä»€ä¹ˆï¼Ÿ</p></blockquote><h2 id="é¢å‘å¯¹è±¡"><a href="#é¢å‘å¯¹è±¡" class="headerlink" title="é¢å‘å¯¹è±¡"></a>é¢å‘å¯¹è±¡</h2><blockquote><p>ä½ ä¸è¦æŠŠFPé‚£å¥—ä¸œè¥¿æè¿‡æ¥ï¼ŒåŒæ—¶ä¹Ÿä¸è¦OOPé‚£å¥—ä¸œè¥¿æè¿‡æ¥ï¼ŒRustå°±æ˜¯Rustã€‚</p></blockquote><p>Rustå¯ä»¥ç”¨trait objectæ¥è¡¨è¾¾å¤šæ€ï¼Œä½†æ˜¯ç¼–è¯‘å™¨éœ€è¦åœ¨ç¼–è¯‘æœŸçŸ¥é“å‡½æ•°çš„å‚æ•°ã€å±€éƒ¨å˜é‡çš„å¤§å°ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»å¥—ä¸Šä¸€ä¸ªå¼•ç”¨æˆ–è€…Boxã€‚è€Œä¸”ç¼–è¯‘å™¨å¯¹trait objectæœ‰é¢å¤–çš„é™åˆ¶ï¼š</p><blockquote><p>Object Safety Is Required for Trait Objects<br>You can only make object-safe traits into trait objects. Some complex rules govern all the properties that make a trait object safe, but in practice, only two rules are relevant. A trait is object safe if <strong>all the methods</strong> defined in the trait have the following properties:</p><ul><li>The return type isnâ€™t Self.</li><li>There are no generic type parameters.</li></ul></blockquote><p><a href="https://doc.rust-lang.org/book/ch17-02-trait-objects.html">https://doc.rust-lang.org/book/ch17-02-trait-objects.html</a></p><p><strong>æ‰€æœ‰çš„</strong>æ–¹æ³•éƒ½ä¸èƒ½æœ‰æ³›å‹å‚æ•°ï¼Œé›¶<del>æˆæœ¬</del>æŠ½è±¡ã€‚ä¸è¿‡åœ¨è€ä¸€ç‚¹çš„æ–‡æ¡£é‡Œæœ‰å¦å¤–ä¸€æ¡ï¼Œè¿™ä¸€ç‚¹æˆ‘ä¹Ÿè®¤ä¸ºéå¸¸å‘çˆ¹ï¼ŒRustçš„æ–‡æ¡£æ•£è½åœ¨ä¸–ç•Œçš„å„ä¸ªè§’è½é‡Œã€‚</p><blockquote><p>ä½ æ¸´æœ›åŠ›é‡å—ï¼Ÿ</p></blockquote><p><a href="https://doc.rust-lang.org/book/title-page.html">https://doc.rust-lang.org/book/title-page.html</a></p><p><a href="https://doc.rust-lang.org/edition-guide/rust-2018/index.html">https://doc.rust-lang.org/edition-guide/rust-2018/index.html</a></p><p><a href="https://doc.rust-lang.org/1.19.0/book/first-edition/README.html">https://doc.rust-lang.org/1.19.0/book/first-edition/README.html</a></p><p>åœ¨<strong>è€ç‰ˆ</strong>çš„Rust Booké‡Œé¢å…³äºobject safetyæœ‰æ›´è¯¦ç»†çš„æè¿°ï¼š</p><blockquote><p>The error says that <code>Clone</code> is not â€˜object-safeâ€™. Only traits that are object-safe can be made into trait objects. A trait is object-safe if both of these are true:</p><ul><li>the trait does not require that <code>Self: Sized</code></li><li>all of its methods are object-safe</li></ul><p>So what makes a method object-safe? Each method must require that <code>Self: Sized</code> or all of the following:</p><ul><li>must not have any type parameters</li><li>must not use <code>Self</code></li></ul></blockquote><p>Each method must require that <code>Self: Sized</code> <strong>or</strong> all of the followingâ€¦</p><p>æ–°ç‰ˆä¸ä»…æŠŠè¿™å¥è¯åˆ äº†ï¼Œæˆ‘ä¸çŸ¥é“æ˜¯æ€ä¹ˆæƒ³çš„ã€‚è¿™é‡Œå¯ä»¥ç†è§£ä¸ºåŠ äº†<code>Self: Sized</code> å°±å¯ä»¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œä¸æ­¤åŒæ—¶trait objectå°±ä¸èƒ½å†è°ƒç”¨è¿™ä¸ªæ–¹æ³•äº†ï¼Œ<del>æ¬²ç»ƒæ­¤åŠŸï¼Œå¿…å…ˆè‡ªå®«</del>ã€‚</p><p>ä¾æ®è¿™ä¸€æ¡ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥å®šä¹‰Iteratorã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Iterator</span></span>&lt;E&gt;&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; E;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">flat_map</span></span>&lt;B,F&gt;(<span class="keyword">self</span>,f: F) -&gt; FlatMap&lt;<span class="keyword">Self</span>,F&gt; </span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">Self</span>: <span class="built_in">Sized</span>,F: <span class="built_in">Fn</span>(E) -&gt; <span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> <span class="built_in">Iterator</span>&lt;B&gt;&gt;&#123;</span><br><span class="line">        Map(<span class="keyword">self</span>,f)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼ºç‚¹å°±æ˜¯ä½ éœ€è¦åœ¨å„ç§åœ°æ–¹å¥—Boxã€‚</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><blockquote><p>å”å”ï¼Œå”å”ï¼Œå¬è¯´ä½ ä»¬è¿™ä¸ªè¯­è¨€å†™ä¸äº†é“¾è¡¨æ˜¯å—ï¼Ÿ</p></blockquote><p>Rustçš„å¼•ç”¨è§„åˆ™å¾ˆç®€å•ï¼šå¯å˜å¼•ç”¨å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªï¼Œä¸å¯ä»¥å¼•ç”¨åŒæ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œè€Œå¯å˜å¼•ç”¨å­˜åœ¨çš„æ—¶å€™ä¸èƒ½åˆ›å»ºä¸å¯å˜å¼•ç”¨ã€‚</p><p>å¸¸è§çš„é“¾è¡¨nextæ˜¯ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼ŒtailæŒ‡é’ˆä¹Ÿæ˜¯å¯å˜çš„ï¼Œä»–ä»¬åŒæ—¶æŒ‡å‘é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ˜¯Rustç»•ä¸è¿‡å»çš„åã€‚</p><p>è§„åˆ™ç®€å•ï¼Œä¸ä»£è¡¨ä»–ç”¨èµ·æ¥å®¹æ˜“ã€‚ä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªè§„åˆ™ï¼Œå°±é©¬ä¸Šæƒ³åˆ°Rustä¸ç”¨unsafeæ— æ³•å®ç°é“¾è¡¨ï¼Œç„¶åäº«å—ä¸€ä¸ªå‘¨æœ«è€Œä¸æ˜¯å’Œç¼–è¯‘å™¨æ­»ç£•å—ï¼Ÿ</p><h3 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h3><blockquote><p>ç‹å ï¼šrustæ‰€è°“çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯æŠŠå¼•ç”¨è®¡æ•°é™åˆ¶ä¸º1ï¼Œé‚£å¤„ç†èµ·æ¥å½“ç„¶ç®€å•äº†ã€‚</p></blockquote><p>ä¸å¾—ä¸ä½©æœç‹å çš„æ•é”ï¼Œé‚£ä¹ˆè¿™å¥è¯è¦å¦‚ä½•ç†è§£å‘¢ï¼Ÿå› ä¸ºçœ‹ä¸Šå»rustå…è®¸å¤šä¸ªä¸å¯å˜å¼•ç”¨ã€‚</p><p>è¿™ä¹Ÿæ˜¯ç”Ÿå‘½å‘¨æœŸçš„è®¾è®¡ç†å¿µï¼Œå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸè¢«åŒ…å«åœ¨å€¼çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæ‰€ä»¥ä»–å¯ä»¥ç›´æ¥å¿½ç•¥ï¼Œç”±æ‰€æœ‰è€…è´Ÿè´£é‡Šæ”¾ï¼Œè€Œæ‰€æœ‰è€…å°±æ˜¯é‚£ä¸ª1ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½ æƒ³åœ¨çº¿ç¨‹ä¹‹é—´ä¼ å¼•ç”¨é€šå¸¸æ˜¯ä¸€ä¸ªé”™è¯¯çš„é€‰æ‹©ã€‚</p><p>è€Œå¯å˜å¼•ç”¨çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå‡å¦‚æŠŠå¼•ç”¨æŒ‡å‘å¦å¤–ä¸€ä¸ªå€¼ï¼Œä»–éœ€è¦é‡Šæ”¾å‰ä¸€ä¸ªå€¼ã€‚</p><blockquote><p>è¿™éƒ½ä¸çŸ¥é“ï¼Ÿå†å»çœ‹çœ‹TRPLå§ï¼Œéƒ½åœ¨é‡Œé¢ã€‚</p></blockquote><h2 id="TRPL"><a href="#TRPL" class="headerlink" title="TRPL"></a>TRPL</h2><p>è¯´åˆ°è¿™é‡Œå°±ä¸å¾—ä¸æ<code>The Rust Programming Language</code>ï¼ŒRustå¹ä»¬æŠŠä»–ç®€ç§°ä¸ºTRPLä»¥ç¤ºå°Šæ•¬ã€‚ä½ å¿…é¡»çŸ¥é“å®ƒï¼ŒåŒæ—¶ä¹Ÿå¿…é¡»çŸ¥é“è¿™ä¸ªç¼©å†™ã€‚</p><p>é‚£ä¹ˆTRPLï¼Œæœ‰æ²¡æœ‰é‚£ä¹ˆè¯¦ç»†ï¼Ÿæ˜¾ç„¶æ˜¯æ²¡æœ‰çš„ï¼Œé¦–å…ˆä»–ç›¸å¯¹äºè€çš„æ–‡æ¡£åšè¿‡ä¸€å®šçš„åˆ å‡ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„trait objectã€‚é‚£å›åˆ°æ­£é¢˜ï¼Œæˆ‘è®¤ä¸ºè¿™ç¯‡æ–‡æ¡£æ¼æ‰äº†ä¸€ä¸ªç›¸å½“é‡è¦çš„ä¸œè¥¿å°±æ˜¯<code>std::mem::replace</code>ï¼ŒOptioné‡ŒæŠŠä»–åŒ…è£…æˆ<code>take</code>ã€‚ä»–çš„ä½œç”¨æ˜¯æŠŠæ—§çš„å€¼å–å‡ºæ¥ï¼ŒåŒæ—¶ç»™ä¸€ä¸ªæ–°å€¼ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹åŸæ¥çš„å€¼éšæ„æ“ä½œäº†ã€‚æˆ‘è®¤ä¸ºåœ¨ä½ çŸ¥é“è¿™ä¸ªä¸œè¥¿ä¹‹å‰ï¼Œä½ å¯èƒ½è‡³å°‘ä¼šæµªè´¹ä¸€ä¸ªæ˜ŸæœŸå°è¯•å»å¯¹å¯å˜å¼•ç”¨åšæ¨¡å¼åŒ¹é…ï¼Œç›´åˆ°ä½ çŸ¥é“æœ‰è¿™ä¸ªä¸œè¥¿ï¼Œæˆ–è€…ç²¾é€šunsafeã€‚</p><p>æ¯”å¦‚ï¼Œå‡å¦‚æˆ‘æƒ³æŠŠæ ˆé¡¶å–å‡ºæ¥ï¼Œç„¶åå‘åæŒªä¸€ä½ï¼Œå¯èƒ½ä¼šè¿™ä¹ˆå®ç°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Stack</span></span>&lt;E&gt; &#123;</span><br><span class="line">    More(E,<span class="built_in">Box</span>&lt;Stack&lt;E&gt;&gt;),</span><br><span class="line">    Less</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> &lt;E&gt; Stack&lt;E&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>() -&gt; Stack&lt;E&gt;&#123;</span><br><span class="line">        Stack::Less</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">pop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;E&gt;&#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Stack::More(item,next) =&gt; &#123;</span><br><span class="line">                *<span class="keyword">self</span> = **next;</span><br><span class="line">                <span class="literal">Some</span>(*item)</span><br><span class="line">            &#125;,</span><br><span class="line">            Stack::Less =&gt; <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä½ æ˜¾ç„¶çŠ¯äº†é”™è¯¯ï¼Œselfå¯å˜å¼•ç”¨å­˜åœ¨çš„åŒæ—¶ï¼Œæ¨¡å¼åŒ¹é…ä¼šåˆ›å»ºæ–°çš„å¼•ç”¨ã€‚é‚£æœ‰äº†replaceï¼Œå°±å¯ä»¥è¿™æ ·å†™ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">pop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;E&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> pre = std::mem::replace(<span class="keyword">self</span>, Stack::Less);</span><br><span class="line">    <span class="keyword">match</span> pre &#123;</span><br><span class="line">        Stack::More(item,next) =&gt; &#123;</span><br><span class="line">            *<span class="keyword">self</span> = *next;</span><br><span class="line">            <span class="literal">Some</span>(item)</span><br><span class="line">        &#125;,</span><br><span class="line">        Stack::Less =&gt; <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ˜¾ç„¶ä¸å¤Ÿ<strong>é›¶æˆæœ¬æŠ½è±¡</strong>ï¼Œå› ä¸ºLessæ˜¯ä¸€ä¸ªåƒåœ¾å€¼ï¼Œéšåå°±ä¼šè¢«é‡Šæ”¾æ‰ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨unsafeã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">pop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;E&gt;&#123;</span><br><span class="line">    <span class="keyword">match</span> <span class="keyword">unsafe</span>&#123;std::ptr::read(<span class="keyword">self</span>)&#125; &#123;</span><br><span class="line">        Stack::More(item,next) =&gt; &#123;</span><br><span class="line">            <span class="keyword">unsafe</span>&#123;std::ptr::write(<span class="keyword">self</span>, *next)&#125;</span><br><span class="line">            <span class="literal">Some</span>(item)</span><br><span class="line">        &#125;,</span><br><span class="line">        Stack::Less =&gt; <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»€ä¹ˆï¼Œç«Ÿç„¶æœ‰äººåœ¨ç”¨unsafe? unsafe è­¦å¯Ÿï¼Œå‡ºè­¦ğŸ‘®â€â™€ï¸ï¼</p></blockquote><h2 id="å­¦ä¹ æˆæœ¬"><a href="#å­¦ä¹ æˆæœ¬" class="headerlink" title="å­¦ä¹ æˆæœ¬"></a>å­¦ä¹ æˆæœ¬</h2><blockquote><p>å¾ˆå¤šäººä»¥ä¸ºRustå­¦ä¹ æˆæœ¬å¾ˆé«˜ï¼Œä»–åªä¸è¿‡æŠŠå¤æ‚çš„éƒ¨åˆ†éƒ½æš´éœ²å‡ºæ¥äº†ã€‚</p></blockquote><p>ä¸ï¼ŒRustçš„å­¦ä¹ æˆæœ¬æ¯”ä½ æƒ³è±¡çš„è¿˜è¦é«˜ã€‚ä¸ä»…ä»…æ˜¯å­¦ä¹ è¯­æ³•ï¼Œè€Œæ˜¯èŠ±å¤§é‡ä½†æ—¶é—´æ€»ç»“åœ¨è¿™ä¸€å¥—é™åˆ¶ä¹‹ä¸‹è¯¥å¦‚ä½•å†™ä»£ç ã€‚æ­£å¦‚åŒå­¦ä¹ å¦‚ä½•æˆ´ç€é•£é“è·³èˆğŸ’ƒğŸ’ƒğŸ’ƒã€‚</p><p>é‚£ä¹ˆRustå€¼å¾—å—ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™ä¸–ç•Œæœ‰å¤ªå¤šçš„ä¼ æ•™å£«äº†ï¼Œæ¯”å¦‚&lt;strong&gt;ä¸€éƒ¨åˆ†&lt;/strong&gt;Haskellä¼ æ•™å£«ä¼šæ‹¿ä¸€ä¸ªä¸¤è¡Œçš„å¿«æ’ï¼Œä½†æ˜¯ä¸å‘Šè¯‰ä½ é‚£ä¸æ˜¯åŸåœ°æ’åºï¼Œè€Œç­‰ä»·çš„åŸåœ°æ’åºå¯èƒ½æ¯”javaè¿˜é•¿ã€‚&lt;/p&gt;
&lt;p&gt;é‚£RustçœŸçš„æœ‰ä¼ æ•™å£«è¯´çš„é‚£ä¹ˆç¾å—ï¼Œæ˜¯å¦é—æ¼äº†ä»€ä¹ˆã€‚&lt;/p&gt;
&lt;h2 id=&quot;trai
      
    
    </summary>
    
      <category term="rust" scheme="https://ezksd.github.io/categories/rust/"/>
    
    
  </entry>
  
  <entry>
    <title>è‡ªå®šä¹‰Zshä¸»é¢˜</title>
    <link href="https://ezksd.github.io/2019/05/06/custom-zsh-theme/"/>
    <id>https://ezksd.github.io/2019/05/06/custom-zsh-theme/</id>
    <published>2019-05-06T23:45:44.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€ç›´åœ¨ç”¨zshçš„ä¸»é¢˜ysã€‚ä¸€ç›´æœ‰ä¸€ä¸ªå¾ˆçƒ¦çš„é—®é¢˜ï¼Œåˆšè¿›å…¥shellçš„æ—¶å€™æœ€ä¸Šé¢æœ‰ä¸€ä¸ªç©ºè¡Œçœ‹èµ·æ¥ååˆ†éš¾å—ã€‚<br>ä»Šå¤©æƒ³èµ·æ¥è§£å†³äº†ä¸€ä¸‹ï¼Œå‘ç°å¹¶ä¸å›°éš¾ã€‚</p><p>zshçš„ä¸»é¢˜å°±æ˜¯ä¸€ä¸ªshellæ–‡ä»¶ï¼Œä¿®æ”¹å˜é‡PROMTå°±å¥½äº†ï¼Œè€Œysè¿™ä¸ªä¸»é¢˜<a href="https://github.com/robbyrussell/oh-my-zsh/blob/master/themes/ys.zsh-theme">ys.zsh-theme</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PROMPT=&quot;</span><br><span class="line"><span class="meta">%</span><span class="bash">&#123;<span class="variable">$terminfo</span>[bold]<span class="variable">$fg</span>[blue]%&#125;<span class="comment">#%&#123;$reset_color%&#125; \</span></span></span><br><span class="line"><span class="bash">%(<span class="comment">#,%&#123;$bg[yellow]%&#125;%&#123;$fg[black]%&#125;%n%&#123;$reset_color%&#125;,%&#123;$fg[cyan]%&#125;%n) \</span></span></span><br><span class="line"><span class="bash">%&#123;<span class="variable">$fg</span>[white]%&#125;@ \</span></span><br><span class="line"><span class="bash">%&#123;<span class="variable">$fg</span>[green]%&#125;%m \</span></span><br><span class="line"><span class="bash">%&#123;<span class="variable">$fg</span>[white]%&#125;<span class="keyword">in</span> \</span></span><br><span class="line"><span class="bash">%&#123;<span class="variable">$terminfo</span>[bold]<span class="variable">$fg</span>[yellow]%&#125;%~%&#123;<span class="variable">$reset_color</span>%&#125;\</span></span><br><span class="line"><span class="bash"><span class="variable">$&#123;hg_info&#125;</span>\</span></span><br><span class="line"><span class="bash"><span class="variable">$&#123;git_info&#125;</span>\</span></span><br><span class="line"><span class="bash"> \</span></span><br><span class="line"><span class="bash">%&#123;<span class="variable">$fg</span>[white]%&#125;[%*] <span class="variable">$exit_code</span></span></span><br><span class="line"><span class="meta">%</span><span class="bash">&#123;<span class="variable">$terminfo</span>[bold]<span class="variable">$fg</span>[red]%&#125;$ %&#123;<span class="variable">$reset_color</span>%&#125;<span class="string">&quot;</span></span></span><br></pre></td></tr></table></figure><p>åœ¨å¼€å¤´çš„æ—¶å€™å°±åŠ äº†ä¸€ä¸ªæ¢è¡Œï¼ŒæŠŠä»–å»æ‰å‘½ä»¤ä¹‹é—´åˆå¤ªç´§å‡‘äº†ã€‚è€Œ<code>PROMT</code>æ˜¯ä¸€ä¸ªå˜é‡ï¼Œèµ‹å€¼æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåœ¨é‡Œé¢æ’ä¸€ä¸ªå¸¦çŠ¶æ€çš„å‡½æ•°åˆè¡Œä¸é€šã€‚</p><p>å¥½åœ¨æ–‡æ¡£é‡Œæœ‰ä¸€ä¸ªå‡½æ•°<a href="http://zsh.sourceforge.net/Doc/Release/Functions.html"><code>precmd</code></a>ï¼Œæ¥ä¸‹æ¥å°±å¾ˆç®€å•äº†ï¼ŒæŠŠè¿™ä¸ªæ’å…¥åˆ°è¦ä¿®æ”¹çš„ä¸»é¢˜ï¼Œå†æŠŠ<code>PROMPT</code>å†æŠŠå‰é¢çš„æ¢è¡Œåˆ æ‰å°±å¥½äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">local prompt_prefix_flag=false</span><br><span class="line">function precmd()&#123;</span><br><span class="line">    if $prompt_prefix_flag; then</span><br><span class="line">        echo &quot;&quot;</span><br><span class="line">    else</span><br><span class="line">        prompt_prefix_flag=true</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸€ç›´åœ¨ç”¨zshçš„ä¸»é¢˜ysã€‚ä¸€ç›´æœ‰ä¸€ä¸ªå¾ˆçƒ¦çš„é—®é¢˜ï¼Œåˆšè¿›å…¥shellçš„æ—¶å€™æœ€ä¸Šé¢æœ‰ä¸€ä¸ªç©ºè¡Œçœ‹èµ·æ¥ååˆ†éš¾å—ã€‚&lt;br&gt;ä»Šå¤©æƒ³èµ·æ¥è§£å†³äº†ä¸€ä¸‹ï¼Œå‘ç°å¹¶ä¸å›°éš¾ã€‚&lt;/p&gt;
&lt;p&gt;zshçš„ä¸»é¢˜å°±æ˜¯ä¸€ä¸ªshellæ–‡ä»¶ï¼Œä¿®æ”¹å˜é‡PROMTå°±å¥½äº†ï¼Œè€Œysè¿™ä¸ªä¸»é¢˜&lt;a href=&quot;https://g
      
    
    </summary>
    
      <category term="shell" scheme="https://ezksd.github.io/categories/shell/"/>
    
    
  </entry>
  
  <entry>
    <title>Rustå®ç°å‡½æ•°å¼åˆ—è¡¨</title>
    <link href="https://ezksd.github.io/2019/03/27/rust-functional-list/"/>
    <id>https://ezksd.github.io/2019/03/27/rust-functional-list/</id>
    <published>2019-03-27T15:49:18.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡æœ‰å‚è€ƒï¼ˆLearn Rust With Entirely Too Many Linked Lists)[<a href="https://rust-unofficial.github.io/too-many-lists/index.html]%EF%BC%8C%E4%BD%86%E5%8E%9F%E6%96%87%E4%B8%AD%E8%B7%B3%E8%BF%87%E4%BA%86%E5%BE%88%E5%A4%9A%E9%9A%BE%E5%A4%84%E7%90%86%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E6%AF%94%E5%A6%82%E7%94%A8Option%E4%BB%A3%E6%9B%BF%E4%BB%A3%E6%95%B0%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%EF%BC%8C%E9%93%BE%E8%A1%A8%E5%92%8C%E8%8A%82%E7%82%B9%E5%88%86%E5%BC%80%E5%AE%9A%E4%B9%89%EF%BC%8C%E6%98%BE%E7%84%B6%E8%BF%99%E6%98%BE%E7%84%B6%E5%BE%88%E4%B8%8D%E5%87%BD%E6%95%B0%E5%BC%8F%E3%80%82">https://rust-unofficial.github.io/too-many-lists/index.html]ï¼Œä½†åŸæ–‡ä¸­è·³è¿‡äº†å¾ˆå¤šéš¾å¤„ç†çš„æƒ…å†µï¼Œæ¯”å¦‚ç”¨Optionä»£æ›¿ä»£æ•°æ•°æ®ç±»å‹ï¼Œé“¾è¡¨å’ŒèŠ‚ç‚¹åˆ†å¼€å®šä¹‰ï¼Œæ˜¾ç„¶è¿™æ˜¾ç„¶å¾ˆä¸å‡½æ•°å¼ã€‚</a></p></blockquote><p>Rustå’ŒHaskelléå¸¸ç›¸ä¼¼ï¼Œæ¯”å¦‚æœ‰ADTã€æ¨¡å¼åŒ¹é…ï¼Œtrait/implå’Œclass/instanceå‡ ä¹æ˜¯ä¸€æ ·çš„ã€‚<br>åˆ—è¡¨æ˜¯å‡½æ•°å¼è¯­è¨€ä¸­æœ€å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œä¸‹é¢å°è¯•åœ¨Rustä¸­å®ç°ä»–ã€‚</p><h2 id="é¦–å…ˆ"><a href="#é¦–å…ˆ" class="headerlink" title="é¦–å…ˆ"></a>é¦–å…ˆ</h2><p>åœ¨Haskellä¸­Listå¤§æ¦‚æ˜¯è¿™æ ·ï¼š</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span> <span class="type">List</span> a = <span class="type">Cons</span> a (<span class="type">List</span> <span class="title">a</span>) | <span class="type">Nil</span></span></span><br></pre></td></tr></table></figure><p>ç¿»è¯‘æˆRustï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span>&lt;T&gt;&#123;</span><br><span class="line">    Cons(T,List&lt;T&gt;),</span><br><span class="line">    Nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">error[E0072]: recursive <span class="built_in">type</span> `List` has infinite size</span><br><span class="line"> --&gt; src/lib.rs:6:1</span><br><span class="line">  |</span><br><span class="line">6 | enum List&lt;T&gt;&#123;</span><br><span class="line">  | ^^^^^^^^^^^^ recursive <span class="built_in">type</span> has infinite size</span><br><span class="line">7 |     Cons(T,List&lt;T&gt;),</span><br><span class="line">  |            ------- recursive without indirection</span><br><span class="line">  |</span><br></pre></td></tr></table></figure><p>Rustéœ€è¦åœ¨ç¼–è¯‘æœŸçŸ¥é“çŸ¥é“ç»“æ„ä½“/æšä¸¾çš„å¤§å°ï¼Œè¿™é‡Œæ˜¯é€’å½’çš„æ•°æ®ç»“æ„ï¼Œè€Œå¼•ç”¨æˆ–æ˜¯æŒ‡é’ˆå¤§å°æ˜¯å›ºå®šçš„ã€‚æ¶‰åŠåˆ°å¼•ç”¨å°±å¿…é¡»åŠ ä¸Šlifetimeï¼Œç„¶åå®ƒå°±å˜æˆäº†è¿™æ ·ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span>&lt;<span class="symbol">&#x27;a</span>,T&gt;&#123;</span><br><span class="line">    Cons(T,&amp;<span class="symbol">&#x27;a</span> List&lt;<span class="symbol">&#x27;a</span>,T&gt;),</span><br><span class="line">    Nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ˆä¸Šå¼•ç”¨å¯èƒ½ä¼šå‡ºç°æ‚¬æŒ‚æŒ‡é’ˆçš„é—®é¢˜ã€‚</p><blockquote><p>cannot return value referencing temporary value<br>returns a value referencing data owned by the current function</p></blockquote><h2 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h2><blockquote><p>A pointer type for heap allocation.<br><code>Box&lt;T&gt;</code>, casually referred to as a â€˜boxâ€™, provides the simplest form of heap allocation in Rust. Boxes provide ownership for this allocation, and drop their contents when they go out of scope.</p></blockquote><p>Boxæ˜¯åœ¨å †ä¸Šåˆ†é…çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">List</span></span>&lt;T&gt; &#123;</span><br><span class="line">    Cons(T, <span class="built_in">Box</span>&lt;List&lt;T&gt;&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> List&lt;<span class="built_in">u32</span>&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">range</span></span>(l: <span class="built_in">i32</span>, h: <span class="built_in">i32</span>) -&gt; List&lt;<span class="built_in">i32</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> l &lt; h &#123;</span><br><span class="line">            List::Cons(l, <span class="built_in">Box</span>::new(List::range(l + <span class="number">1</span>, h)))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List::Nil</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿­ä»£å™¨"><a href="#è¿­ä»£å™¨" class="headerlink" title="è¿­ä»£å™¨"></a>è¿­ä»£å™¨</h2><p>Iteratoréœ€è¦å®ç°çš„æ–¹æ³•ç­¾å:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt;;</span><br></pre></td></tr></table></figure><p>å¯¹åº”ä¸åŒç±»å‹çš„å…ƒç´ ï¼ˆSelf::Item)ï¼Œä½†ç»“æ„ä½“æœ¬èº«è¿˜æ˜¯å¿…è¦ï¼Œå› ä¸ºéœ€è¦ä¿å­˜ä¸­é—´éå†çš„ä½ç½®ã€‚</p><ul><li>T -&gt; IntoIter</li><li>&amp;T -&gt; Iter</li><li>&amp;mut T -&gt; IterMut</li></ul><p>å…ˆä»IntoIterå¼€å§‹ï¼Œåˆæ­¥å®ç°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IntoIter</span></span>&lt;T&gt;(List&lt;T&gt;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> &lt;T&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> IntoIter&lt;T&gt;&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.<span class="number">0</span> &#123;</span><br><span class="line">            List::Cons(item,rest) =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="number">0</span> = *rest;</span><br><span class="line">                <span class="literal">Some</span>(item)</span><br><span class="line">            &#125;</span><br><span class="line">            List::Nil =&gt; <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">error[E0507]: cannot <span class="keyword">move</span> out of `<span class="keyword">self</span>.<span class="number">0.1</span>` which is behind a mutable reference</span><br><span class="line">  --&gt; src/main.rs:<span class="number">21</span>:<span class="number">15</span></span><br><span class="line">   |</span><br><span class="line"><span class="number">21</span> |         <span class="keyword">match</span> <span class="keyword">self</span>.<span class="number">0</span> &#123;</span><br><span class="line">   |               ^^^^^^ help: consider borrowing here: `&amp;<span class="keyword">self</span>.<span class="number">0</span>`</span><br><span class="line"><span class="number">22</span> |             List::Cons(item,rest) =&gt; &#123;</span><br><span class="line">   |                             ----</span><br><span class="line">   |                             |</span><br><span class="line">   |                             data moved here</span><br><span class="line">   |                             <span class="keyword">move</span> occurs because `rest` has <span class="class"><span class="keyword">type</span> `<span class="title">std</span></span>::boxed::<span class="built_in">Box</span>&lt;List&lt;T&gt;&gt;`, which does not implement the `<span class="built_in">Copy</span>` <span class="class"><span class="keyword">trait</span></span></span><br><span class="line"><span class="class">           ^^^^ ^^^^</span></span><br></pre></td></tr></table></figure><p>List,Boxå‡æ²¡æœ‰å®ç°Copyï¼Œæ‰€ä»¥å‡ºç°äº†moveï¼Œä½†æ˜¯å¼•ç”¨æ²¡æœ‰æ‰€æœ‰æƒã€‚</p><h2 id="std-mem-replace"><a href="#std-mem-replace" class="headerlink" title="std::mem::replace"></a>std::mem::replace</h2><p><a href="https://doc.rust-lang.org/std/mem/fn.replace.html">https://doc.rust-lang.org/std/mem/fn.replace.html</a></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">replace</span></span>&lt;T&gt;(dest: &amp;<span class="keyword">mut</span> T, src: T) -&gt; T</span><br><span class="line"><span class="comment">// Moves src into the referenced dest, returning the previous dest value.Neither value is dropped.</span></span><br></pre></td></tr></table></figure><p>å…ˆå¡ä¸€ä¸ªList::Nilè¿›å»æŠŠæ—§å€¼æ¢å‡ºæ¥ï¼Œè¿™æ ·å°±è·å¾—äº†æ—§å€¼çš„æ‰€æœ‰æƒã€‚Optionçš„takeæ–¹æ³•å°±æ˜¯replaceçš„åŒ…è£…ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> &lt;T&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> IntoIter&lt;T&gt;&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> std::mem::replace(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span>,List::Nil) &#123;</span><br><span class="line">            List::Cons(item,rest) =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="number">0</span> = *rest;</span><br><span class="line">                <span class="literal">Some</span>(item)</span><br><span class="line">            &#125;</span><br><span class="line">            List::Nil =&gt; <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Iterï¼ˆä¹Ÿå°±æ˜¯Itemç±»å‹ä¸º&amp;Tï¼‰æ¯”è¾ƒé¡ºç•…ï¼Œå› ä¸ºæœ‰å¼•ç”¨åŠ ä¸Šäº†ç”Ÿå‘½å‘¨æœŸï¼Œè¿”å›å€¼å’Œåˆ—è¡¨ç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Iter</span></span>&lt;<span class="symbol">&#x27;a</span>,T&gt;(&amp;<span class="symbol">&#x27;a</span> List&lt;T&gt;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> &lt;<span class="symbol">&#x27;a</span>,T&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> Iter&lt;<span class="symbol">&#x27;a</span>,T&gt;&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = &amp;<span class="symbol">&#x27;a</span> T;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.<span class="number">0</span> &#123;</span><br><span class="line">            List::Cons(item,rest) =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="number">0</span> = rest;</span><br><span class="line">                <span class="literal">Some</span>(item)</span><br><span class="line">            &#125;</span><br><span class="line">            List::Nil =&gt; <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¯¹äºå…ƒç´ ç±»å‹ä¸º&amp;mut Tçš„è¿­ä»£å™¨åˆæœ‰æ–°çš„é—®é¢˜ã€‚ï¼ˆåƒç´ çº§æ‹·è´ä¸Šè¿°ä»£ç ï¼Œå°±ä¸è´´äº†ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">error[E0495]: cannot infer an appropriate lifetime <span class="keyword">for</span> pattern due to conflicting requirements</span><br><span class="line">  --&gt; src/main.rs:54:24</span><br><span class="line">   |</span><br><span class="line">54 |             List::Cons(item,rest) =&gt;&#123;</span><br><span class="line">   |                        ^^^^</span><br><span class="line">   |</span><br><span class="line">note: first, the lifetime cannot outlive the anonymous lifetime <span class="comment">#1 defined on the method body at 52:5...</span></span><br><span class="line">  --&gt; src/main.rs:52:5</span><br><span class="line">   |</span><br><span class="line">52 |     fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; &#123;</span><br><span class="line">   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">note: ...so that reference does not outlive borrowed content</span><br><span class="line">  --&gt; src/main.rs:54:24</span><br><span class="line">   |</span><br><span class="line">54 |             List::Cons(item,rest) =&gt;&#123;</span><br><span class="line">   |                        ^^^^</span><br><span class="line">note: but, the lifetime must be valid <span class="keyword">for</span> the lifetime `<span class="string">&#x27;a` as defined on the impl at 49:6...</span></span><br><span class="line"><span class="string">  --&gt; src/main.rs:49:6</span></span><br><span class="line"><span class="string">   |</span></span><br><span class="line"><span class="string">49 | impl&lt;&#x27;</span>a,T&gt; Iterator <span class="keyword">for</span> IterMut&lt;<span class="string">&#x27;a,T&gt;&#123;</span></span><br><span class="line"><span class="string">   |      ^^</span></span><br><span class="line"><span class="string">note: ...so that the types are compatible</span></span><br><span class="line"><span class="string">  --&gt; src/main.rs:52:46</span></span><br><span class="line"><span class="string">   |</span></span><br><span class="line"><span class="string">52 |       fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; &#123;</span></span><br><span class="line"><span class="string">   |  ______________________________________________^</span></span><br><span class="line"><span class="string">53 | |         match self.0 &#123;</span></span><br><span class="line"><span class="string">54 | |             List::Cons(item,rest) =&gt;&#123;</span></span><br><span class="line"><span class="string">55 | |                 self.0 = rest.as_mut();</span></span><br><span class="line"><span class="string">...  |</span></span><br><span class="line"><span class="string">63 | |         &#125;</span></span><br><span class="line"><span class="string">64 | |     &#125;</span></span><br><span class="line"><span class="string">   | |_____^</span></span><br><span class="line"><span class="string">   = note: expected `Iterator`</span></span><br><span class="line"><span class="string">              found `Iterator`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">error[E0495]: cannot infer an appropriate lifetime for pattern due to conflicting requirements</span></span><br><span class="line"><span class="string">  --&gt; src/main.rs:54:29</span></span><br><span class="line"><span class="string">   |</span></span><br><span class="line"><span class="string">54 |             List::Cons(item,rest) =&gt;&#123;</span></span><br><span class="line"><span class="string">   |                             ^^^^</span></span><br><span class="line"><span class="string">   |</span></span><br><span class="line"><span class="string">note: first, the lifetime cannot outlive the anonymous lifetime #1 defined on the method body at 52:5...</span></span><br><span class="line"><span class="string">  --&gt; src/main.rs:52:5</span></span><br><span class="line"><span class="string">   |</span></span><br><span class="line"><span class="string">52 |     fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; &#123;</span></span><br><span class="line"><span class="string">   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span></span><br><span class="line"><span class="string">note: ...so that reference does not outlive borrowed content</span></span><br><span class="line"><span class="string">  --&gt; src/main.rs:54:29</span></span><br><span class="line"><span class="string">   |</span></span><br><span class="line"><span class="string">54 |             List::Cons(item,rest) =&gt;&#123;</span></span><br><span class="line"><span class="string">   |                             ^^^^</span></span><br><span class="line"><span class="string">note: but, the lifetime must be valid for the lifetime `&#x27;</span>a` as defined on the impl at 49:6...</span><br><span class="line">  --&gt; src/main.rs:49:6</span><br><span class="line">   |</span><br><span class="line">49 | impl&lt;<span class="string">&#x27;a,T&gt; Iterator for IterMut&lt;&#x27;</span>a,T&gt;&#123;</span><br><span class="line">   |      ^^</span><br><span class="line">note: ...so that reference does not outlive borrowed content</span><br><span class="line">  --&gt; src/main.rs:55:26</span><br><span class="line">   |</span><br><span class="line">55 |                 self.0 = rest.as_mut();</span><br><span class="line">   |                          ^^^^^^^^^^^^^</span><br></pre></td></tr></table></figure><p>è¿™é‡Œself.0åˆ†è£‚æˆäº†ä¸¤ä¸ªä¸äº¤å‰çš„å¯å˜å¼•ç”¨ï¼ˆè¿™æ˜¯åˆæ³•çš„ï¼‰ï¼Œä½†æ˜¯åç»­self.0è¿˜ä¾ç„¶æŒæœ‰selfçš„å¯å˜å¼•ç”¨ï¼Œå› æ­¤å¤šä¸ªå¯å˜å¼•ç”¨å†²çªã€‚ä½†æŠ¥çš„æ˜¯ç”Ÿå‘½å‘¨æœŸçš„é”™ğŸ˜…ã€‚</p><p>è¿™ä¸€æ¬¡éœ€è¦æ›¿æ¢çš„æ˜¯å¼•ç”¨ï¼Œå› æ­¤éœ€è¦åˆ›å»ºä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œå¼•ç”¨å’ŒæŒ‡é’ˆä½†åŒºåˆ«åœ¨äºï¼Œå¼•ç”¨æ˜¯åˆæ³•çš„ï¼Œä½†æŒ‡é’ˆå¯èƒ½æ˜¯éæ³•çš„ï¼Œæ‰€ä»¥è¿™é‡ŒæŠŠå¼•ç”¨æ›¿æ¢å‡ºæ¥ï¼Œä¹‹åè¦æ³¨æ„æŠŠåˆæ³•å¼•ç”¨è¿˜å›å»ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>,T&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> IterMut&lt;<span class="symbol">&#x27;a</span>,T&gt;&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> uninit = MaybeUninit::&lt;&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> List&lt;T&gt;&gt;::uninit();</span><br><span class="line">        <span class="keyword">match</span> std::mem::replace(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span>,<span class="keyword">unsafe</span>&#123;uninit.assume_init()&#125;) &#123;</span><br><span class="line">            List::Cons(item,rest) =&gt;&#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="number">0</span> = rest.as_mut();</span><br><span class="line">                <span class="literal">Some</span>(item)</span><br><span class="line">            &#125;,</span><br><span class="line">            nil @ List::Nil =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="number">0</span> = nil;</span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æ—¢ç„¶ç”¨äº†unsafeï¼Œç›´æ¥ç”¨<code>std::ptr::read</code>æ›´ç®€æ´ï¼Œè€Œä¸”è¿™é‡Œè¯»å‡ºæ¥æ˜¯å¼•ç”¨ï¼Œä¸ç”¨æ‹…å¿ƒé‡å¤dropã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>,T&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> IterMut&lt;<span class="symbol">&#x27;a</span>,T&gt;&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> T;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">unsafe</span>&#123;std::ptr::read(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span>)&#125; &#123;</span><br><span class="line">            List::Cons(item,rest) =&gt;&#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="number">0</span> = rest.as_mut();</span><br><span class="line">                <span class="literal">Some</span>(item)</span><br><span class="line">            &#125;,</span><br><span class="line">            nil @ List::Nil =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="number">0</span> = nil;</span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="unsafe"><a href="#unsafe" class="headerlink" title="unsafe"></a>unsafe</h2><blockquote><p>unsafeè­¦å¯Ÿå‡ºè­¦ï¼ğŸ‘®â€â™€ï¸<br>å› ä¸ºRustçš„å¼ºè¯­æ³•é™åˆ¶ï¼ŒRustçš„unsafeæ˜¯éå¸¸å€¼å¾—äº†è§£çš„ä¸€å—å†…å®¹ï¼Œè€Œå¦ä¸€å—æ˜¯å®ã€‚unsafeä¹Ÿæ²¡æœ‰æƒ³è±¡ä¸­é‚£æ ·ç®€å•ï¼Œunsafeä¸€å¥—ä¸‡äº‹å¤§å‰ã€‚è€Œå‰é¢ä¸¤ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ä½†åŸå› æ˜¯æ¶‰åŠåˆ°çš„éƒ½æ˜¯å¼•ç”¨ï¼Œä¸ç”¨æ‹…å¿ƒå¿˜è®°é‡Šæ”¾å’Œé‡å¤é‡Šæ”¾çš„é—®é¢˜ã€‚</p></blockquote><p>è®©æˆ‘ä»¬é‡æ–°å›é¡¾ä¸€ä¸‹å¼•ç”¨å’Œæ‰€æœ‰æƒè§„åˆ™ã€‚</p><ol><li>ä¸€ä¸ªå€¼åŒæ—¶å¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨</li><li>ä¸€ä¸ªå€¼åŒæ—¶å¯ä»¥æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œå¯å˜å¼•ç”¨å­˜åœ¨çš„åŒæ—¶ä¸èƒ½æœ‰ä¸å¯å˜å¼•ç”¨</li><li>å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸå—ç”Ÿå‘½å‘¨æœŸé™åˆ¶</li></ol><p>è€Œç”Ÿå‘½å‘¨æœŸå°±æ˜¯æŒæœ‰å€¼çš„å½¢å¼å‚æ•°æˆ–å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸï¼Œå› ä¸ºè¢«åŒ…å«åœ¨ä½œç”¨åŸŸå†…ï¼Œç”±æ‰€æœ‰è€…é‡Šæ”¾å°±å¯ä»¥äº†ï¼Œä¸æ­¤åŒæ—¶ä¹Ÿä¸èƒ½è¶…å‡ºç”Ÿå‘½å‘¨æœŸã€‚<br>è€Œå¯å˜å¼•ç”¨ä¸åŒçš„åœ°æ–¹åœ¨äºä»–åœ¨èµ‹äºˆæ–°å€¼çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾æ—§å€¼ã€‚</p><p>ç°åœ¨ç»™ä»–åŠ ä¸€äº›å°çš„å‡½æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> List&lt;<span class="built_in">u32</span>&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">range</span></span>(l: <span class="built_in">u32</span>, h: <span class="built_in">u32</span>) -&gt; List&lt;<span class="built_in">u32</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> r = List::Nil;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> t = h;</span><br><span class="line">        <span class="keyword">while</span> l &lt;= t &#123;</span><br><span class="line">            r = Cons(t,<span class="built_in">Box</span>::new(r));</span><br><span class="line">            t -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        r</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;A&gt; List&lt;A&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">into_iter</span></span>(<span class="keyword">self</span>) -&gt; IntoIter&lt;A&gt; &#123;</span><br><span class="line">        IntoIter(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">iter</span></span>(&amp;<span class="keyword">self</span>) -&gt; Iter&lt;A&gt; &#123;</span><br><span class="line">        Iter(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">iter_mut</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; IterMut&lt;A&gt; &#123;</span><br><span class="line">        IterMut(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = List::range(<span class="number">1</span>, <span class="number">100_000_000</span>).into_iter().fold(<span class="number">0</span>, |_,a| a);</span><br><span class="line">    <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    Finished dev [unoptimized + debuginfo] target(s) <span class="keyword">in</span> 0.46s</span><br><span class="line">     Running `target/debug/temp`</span><br><span class="line">100000000%</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰é—®é¢˜</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = List::range(<span class="number">1</span>, <span class="number">100_000_000</span>).iter().fold(<span class="number">0</span>, |_,a| *a);</span><br><span class="line">    <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ğŸ’¥Boom</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">thread <span class="string">&#x27;main&#x27;</span> has overflowed its stack</span><br><span class="line">fatal runtime error: stack overflow</span><br><span class="line">[1]    15047 abort (core dumped)  cargo run</span><br></pre></td></tr></table></figure><p>è°ƒè¯•ä¸€ä¸‹<br><img src="/images/rust.png" alt="debug"><br>é€’å½’dropçˆ†æ ˆï¼Œè€Œç¬¬ä¸€æ®µä¸çˆ†æ˜¯å› ä¸ºæ‰‹åŠ¨å±•å¼€äº†</p><blockquote><p><strong>After drop is run, Rust will recursively try to drop all of the fields of self.</strong><br>This is a convenience feature so that you donâ€™t have to write â€œdestructor boilerplateâ€ to drop children. If a struct has no special logic for being dropped other than dropping its children, then it means Drop doesnâ€™t need to be implemented at all!<br><strong>There is no stable way to prevent this behavior in Rust 1.0.</strong></p></blockquote><p>å¦‚æœæ‰‹åŠ¨å®ç°Dropï¼Œä½†è¿™é‡Œé“¾è¡¨å’ŒèŠ‚ç‚¹æ˜¯ä¸€ä½“çš„ã€‚è€Œå¯¹Listå®ç°äº†Dropä¹‹åæ— æ³•é€šè¿‡æ¨¡å¼åŒ¹é…å–å€¼ï¼Œåªèƒ½å–å¼•ç”¨ï¼Œè¿™ç›´æ¥å¯¼è‡´Dropå®ç°å¼‚å¸¸å¤æ‚ã€‚ï¼ˆè¿™æ˜¯åŸåšè·³è¿‡çš„åœ°æ–¹ï¼Œè€Œä¸”åŸåšæ—¢ç„¶æåˆ°å‡½æ•°å¼ï¼Œæ²¡æœ‰ç†ç”±ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥ä¿å­˜é“¾è¡¨çš„å¤´ï¼‰</p><p>ç”±äºå®ç°Dropä¹‹åæ— æ³•moveï¼Œè¿™é‡Œç”¨std::ptr::readã€‚readæ˜¯å¤åˆ¶ï¼Œå› æ­¤æ˜¯åˆæ³•çš„ã€‚è¿™é‡Œè¦ååˆ†æ³¨æ„ï¼Œä¸ç„¶å¯èƒ½ä¼šå‡ºç°é‡å¤é‡Šæ”¾ã€‚è¦ä¹ˆè°ƒç”¨forgetï¼Œä¸åšæ¸…ç†ï¼Œè¦ä¹ˆç”¨std::ptr::writeå†™å›å»ï¼Œè€Œwriteæ˜¯ç›´æ¥è¦†ç›–ï¼Œä¸ä¼šé‡Šæ”¾æ—§å€¼ã€‚</p><p>å¦å¤–ï¼Œæ ˆä¸Šçš„å˜é‡æœ¬èº«å°±ä¸éœ€è¦æ˜¾å¼é‡Šæ”¾ï¼Œå‡½æ•°è°ƒç”¨å®Œæ¯•ï¼Œæ ˆå¸§æ”¶ç¼©è‡ªåŠ¨å°±é‡Šæ”¾äº†ï¼Œæ‰€ä»¥è¿™é‡Œæ ¸å¿ƒæ˜¯å †ä¸Šçš„ç»“æ„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> &lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> List&lt;T&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">drop</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> t = std::ptr::read(<span class="keyword">self</span>);</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">let</span> Cons(_,xs) = &amp;t &#123;</span><br><span class="line">                <span class="keyword">let</span> next = std::ptr::read(xs);</span><br><span class="line">                std::ptr::write(&amp;<span class="keyword">mut</span> t, *next);</span><br><span class="line">            &#125;</span><br><span class="line">            std::ptr::write(<span class="keyword">self</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°Dropä¹‹åIntoIterä¹Ÿéœ€è¦ä¿®æ”¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Iterator</span> <span class="keyword">for</span> IntoIter&lt;T&gt; &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = T;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> &amp;<span class="keyword">self</span>.<span class="number">0</span> &#123;</span><br><span class="line">            Cons(item, rest) =&gt; &#123;</span><br><span class="line">                <span class="keyword">unsafe</span>&#123;</span><br><span class="line">                    <span class="keyword">let</span> x = std::ptr::read(item);</span><br><span class="line">                    <span class="keyword">let</span> xs = std::ptr::read(rest);</span><br><span class="line">                    std::ptr::write(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span>, *xs);</span><br><span class="line">                    <span class="literal">Some</span>(x)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Nil =&gt; <span class="literal">None</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡æœ‰å‚è€ƒï¼ˆLearn Rust With Entirely Too Many Linked Lists)[&lt;a href=&quot;https://rust-unofficial.github.io/too-many-lists/index.html]%
      
    
    </summary>
    
      <category term="rust" scheme="https://ezksd.github.io/categories/rust/"/>
    
    
  </entry>
  
  <entry>
    <title>Debug OpenJDK</title>
    <link href="https://ezksd.github.io/2018/11/17/debug-jdk/"/>
    <id>https://ezksd.github.io/2018/11/17/debug-jdk/</id>
    <published>2018-11-17T20:13:16.000Z</published>
    <updated>2021-06-26T13:14:30.033Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><ul><li>ç³»ç»Ÿï¼š ubuntu 18.10</li><li>ç¼–è¾‘å™¨ï¼š vscode</li><li>JDKç‰ˆæœ¬ï¼š openjdk8u</li></ul><h2 id="ä¸‹è½½Openjdk"><a href="#ä¸‹è½½Openjdk" class="headerlink" title="ä¸‹è½½Openjdk"></a>ä¸‹è½½Openjdk</h2><p>å„ç‰ˆæœ¬éƒ½åœ¨<a href="https://hg.openjdk.java.net/">https://hg.openjdk.java.net</a>ï¼Œè¿™é‡Œé€‰æ‹©jdk8uã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hg clone https://hg.openjdk.java.net/jdk8u/jdk8u openjdk</span><br><span class="line">cd openjdk</span><br><span class="line">chmod u+x get_source.sh </span><br><span class="line">./get_source.sh </span><br></pre></td></tr></table></figure><p>hgå‘½ä»¤éœ€è¦äº‹å…ˆå®‰è£…Mercurial.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mercurial</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸‹è½½ç¼“æ…¢å°è¯•è®¾ç½®ä»£ç†,åœ¨<code>/etc/mercurial/hgrc</code>æ–‡ä»¶é‡ŒåŠ å…¥ï¼ˆçœŸçš„éå¸¸æ…¢ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> system-wide mercurial configuration file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See hgrc(5) <span class="keyword">for</span> more information</span></span><br><span class="line">[http_proxy]</span><br><span class="line">host=host:port</span><br><span class="line">[https_proxy]</span><br><span class="line">host=host:port</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p>ç¼–è¯‘jdkéœ€è¦ç³»ç»Ÿå·²ç»å®‰è£…äº†JDKï¼Œç§°ä¸ºbootstrap jdkï¼ˆè€Œä¸”æœ€å¥½æ˜¯å‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ¯”å¦‚ç¼–è¯‘jdk8ï¼Œé‚£ä¹ˆäº‹å…ˆè£…å¥½jdk7ï¼‰ï¼Œå¦‚æœä¸å¯¹å¯ä»¥é€šè¿‡ä¿®æ”¹ç¯å¢ƒå˜é‡æˆ–è€…åŠ ä¸Šconfigureå‚æ•°<code>--with-boot-jdk</code>å‚æ•°æŒ‡å®šjdkè·¯å¾„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br><span class="line">openjdk version &quot;1.8.0_181&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_181-8u181-b13-1ubuntu0.18.10.1-b13)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br></pre></td></tr></table></figure><p>å®‰è£…ä¾èµ–ï¼ˆå‚è€ƒ<code>README</code>ï¼Œä¹Ÿå¯ä»¥<code>configure</code>ä¹‹åä¾æ®æç¤ºå®‰è£…ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libx11-dev libxext-dev libxrender-dev libxtst-dev libxt-dev libcups2-dev</span><br></pre></td></tr></table></figure><p>é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x configure</span><br><span class="line">$ ./configure --enable-debug --with-native-debug-symbols=external</span><br></pre></td></tr></table></figure><p>debug-levelåˆ†slowdebugå’Œfastdebugï¼Œâ€“enable-debugé»˜è®¤ä½fast-debugï¼Œdebug symbolé»˜è®¤æ˜¯å‹ç¼©çš„ï¼Œè®¾ç½®â€“with-native-debug-symbols=externalå…å»æ‰‹åŠ¨è§£å‹çš„å·¥ä½œã€‚</p><p>å°†<code>hotspot/make/linux/makefiles/gcc.make</code>ä¸­çš„<code>WARNINGS_ARE_ERRORS = -Werror</code>æ”¹ä¸º<code>WARNINGS_ARE_ERRORS = -w</code>ï¼Œä¸ç„¶ä¼šå‡ºç°å¦‚ä¸‹å¼‚å¸¸ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc1plus: all warnings being treated as errors</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make all</span><br></pre></td></tr></table></figure><p>å®Œæˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">build/linux-x86_64-normal-server-fastdebug/jdk/bin/java -version</span><br><span class="line">openjdk version &quot;1.8.0-normal-fastdebug&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0-internal-fastdebug)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.71-b00-fastdebug, mixed mode)</span><br></pre></td></tr></table></figure><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>vscodeéœ€è¦å…ˆè£…ä¸Š<code>cpptools</code>æ’ä»¶ï¼Œå¯ä»¥ç›´æ¥åœ¨æ’ä»¶å•†åŸé‡Œæœç´¢<code>c/c++</code>ã€‚</p><p>æ‰“å¼€VSCode, File -&gt; OpenFolderé€‰ä¸­jdkæ–‡ä»¶å¤¹ï¼Œç‚¹å‡»å·¦ä¾§è™«è™«å›¾æ ‡ï¼Œç‚¹å‡»add configurationé€‰ä¸­c/c++ (gdb) Launch,ä¿®æ”¹<code>lauch.json</code>æ–‡ä»¶ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;(gdb) Launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cppdbg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/build/linux-x86_64-normal-server-slowdebug/jdk/bin/java&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;args&quot;</span>: [<span class="string">&quot;-cp&quot;</span>, <span class="string">&quot;~/Desktop&quot;</span>,<span class="string">&quot;Hello&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;environment&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span>: <span class="string">&quot;gdb&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;setupCommands&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Enable pretty-printing for gdb&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;-enable-pretty-printing&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="comment">//&quot;sourceFileMap&quot;:&#123;&quot;/build/glibc-YYA7BZ/glibc-2.31&quot;: &quot;/usr/src/glibc/glibc-2.31&quot;&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦ä¿®æ”¹programå‚æ•°å’Œargså‚æ•°ï¼Œprogramè®¾ç½®ä¸º<code>build/linux-x86_64-normal-server-fastdebug/jdk/bin/java</code>ï¼Œargsè®¾ç½®ä¸ºç¼–è¯‘å¥½çš„classç±»åï¼ˆæˆ‘æ”¾åœ¨æ¡Œé¢ï¼‰ï¼Œæ–­ç‚¹æ‰“åœ¨<code>src/share/vm/prims/jni.cpp</code>æ–‡ä»¶ä¸‹çš„<code>JNI_CreateJavaVM</code>å‡½æ•°ä¸Šï¼Œè¿™é‡Œæ˜¯jvmçš„å…¥å£ï¼Œä½ ä¹Ÿå¯ä»¥æ‰“åœ¨<code>jdk/src/share/bin/main.c</code> çš„mainå‡½æ•°ä¸Šï¼Œè¿™æ ·å·®ä¸å¤šå°±å¯ä»¥å¼€å§‹è°ƒäº†ï¼Œä½†æ˜¯æŸ¥çœ‹æ–‡ä»¶ä¼šéå¸¸å¤šçš„é”™è¯¯æç¤ºæ‰¾ä¸åˆ°æ–‡ä»¶ã€‚</p><p>æ¥ä¸‹æ¥åœ¨<code>.vscode</code>æ–‡ä»¶å¤¹ä¸‹åˆ›å»º<code>c_cpp_properties.json</code>æ–‡ä»¶ï¼Œè¾“å…¥ä»¥ä¸‹å†…å®¹ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Linux&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/hotspot/src/**&quot;</span>, <span class="comment">//hotspotæºæ–‡ä»¶</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/build/linux-x86_64-normal-server-slowdebug/hotspot/linux_amd64_compiler2/generated/**&quot;</span>, <span class="comment">//ç¼–è¯‘ç”Ÿæˆçš„ä»£ç </span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/jdk/src/**&quot;</span>, <span class="comment">//jdkæ ¹ç›®å½•ï¼Œå…¶ä¸­åŒ…æ‹¬å¤§éƒ¨åˆ†çš„å¯æ‰§è¡Œæ–‡ä»¶çš„æºæ–‡ä»¶æ¯”å¦‚javaï¼Œjavacï¼Œè¿˜æœ‰ä¸€äº›nativeæ–¹æ³•çš„å®ç°</span></span><br><span class="line">                <span class="string">&quot;/usr/src/glibc/glibc-2.31/**&quot;</span> , <span class="comment">//libcæºä»£ç </span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;defines&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span>: <span class="string">&quot;/usr/bin/gcc&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span>: <span class="string">&quot;c99&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span>: <span class="string">&quot;c++98&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span>: <span class="string">&quot;gcc-x64&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="number">4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¸€ä¸ªé—®é¢˜å°±æ˜¯è°ƒè¯•é‡åˆ°<code>libc</code>é‡Œçš„å‡½æ•°çš„æ—¶å€™ä¼šå¼¹çª—æç¤ºæ‰¾ä¸åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œé¦–å…ˆæŒ‰ç…§ç³»ç»Ÿæç¤ºå®‰è£…å¯¹åº”ç‰ˆæœ¬çš„<code>glibc</code>æºæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¸‹è½½ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install glibc-source</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œç‰ˆæœ¬æ˜¯glibc-2.31ï¼Œå®‰è£…åœ¨<code>/usr/src/glibc/glibc-2.31.tar.xz</code>ï¼Œè§£å‹åœ¨å½“å‰ç›®å½•ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/glibc</span><br><span class="line">tar -xvf glibc-2.29.tar.xz</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œåœ¨å¼¹é”™è¯¯çš„æ—¶å€™æ³¨æ„æç¤ºæ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œæ˜¯<code>/build/glibc-KRRWSm/glibc-2.29</code>ï¼Œåœ¨<code>launch.json</code>çš„<code>configurations</code>é‡Œé¢åŠ å…¥<code>&quot;sourceFileMap&quot;:&#123;&quot;/build/glibc-KRRWSm/glibc-2.29&quot;: &quot;/usr/src/glibc/glibc-2.29&quot;&#125;</code>ã€‚<code>sourceFileMap</code>é…ç½®å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡æ¡£ï¼š<a href="https://github.com/vadimcn/vscode-lldb/blob/master/MANUAL.md#source-path-remapping">https://github.com/vadimcn/vscode-lldb/blob/master/MANUAL.md#source-path-remapping</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç¯å¢ƒ&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;ç³»ç»Ÿï¼š ubuntu 18.10&lt;/li&gt;
&lt;li&gt;ç¼–è¾‘å™¨ï¼š vscode&lt;/li&gt;
&lt;li&gt;JDKç‰ˆæœ¬ï¼š openjdk8u&lt;
      
    
    </summary>
    
      <category term="jvm" scheme="https://ezksd.github.io/categories/jvm/"/>
    
      <category term="vscode" scheme="https://ezksd.github.io/categories/vscode/"/>
    
    
  </entry>
  
</feed>
